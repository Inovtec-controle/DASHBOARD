<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>KONTROL - Contr√¥le Qualit√© ‚Äì R√©sidences/Bureaux</title>

<!-- iPhone friendly -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#16a34a">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    /* TH√àME CLAIR STYLE APP ORGA / PLANNING */
    --bg:#f1f5f9;
    --panel:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:rgba(148,163,184,.4);
    --brand:#16a34a;
    --brand-2:#22c55e;

    /* Statuts */
    --ok:#16a34a;
    --mid:#eab308;
    --bad:#dc2626;
    --na:#0f172a;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:500 17px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    padding: max(env(safe-area-inset-top), 0px) 0 max(env(safe-area-inset-bottom), 0px) 0;
    -webkit-tap-highlight-color: transparent;
  }

  header.hero{
    padding:16px 16px 12px;
    border-bottom:1px solid var(--border);
    text-align:center;
    background:linear-gradient(135deg,#16a34a12,#22c55e10);
  }
  h1{margin:0 0 8px; font-weight:800; letter-spacing:.2px; font-size:22px}
  .tagline{
    color:var(--muted); font-size:14px; letter-spacing:.2px;
    display:inline-block; padding:6px 12px; border:1px solid var(--border);
    border-radius:999px; background:rgba(255,255,255,.9)
  }

  main{max-width:900px; margin:0 auto; padding:14px 12px 112px}

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    box-shadow:0 10px 30px rgba(15,23,42,.04);
  }
  .card + .card{margin-top:12px}

  label.lbl{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
  input[type="text"], input[type="date"], input[type="time"], textarea{
    width:100%; background:#f8fafc; color:var(--text);
    border:1px solid var(--border); border-radius:12px; padding:12px 12px;
    outline:none; transition:border-color .15s, box-shadow .15s; font-size:16px;
  }
  input:focus, textarea:focus{
    border-color:#22c55e;
    box-shadow:0 0 0 4px rgba(34,197,94,.20);
  }
  textarea{min-height:96px; resize:vertical}

  .row{display:flex; gap:10px; flex-wrap:wrap}
  .grow{flex:1 1 220px; min-width:220px}
  .grow-lg{flex:2 1 360px; min-width:260px}

  button{
    min-height:44px; border-radius:12px; padding:10px 14px; cursor:pointer;
    border:1px solid var(--border); color:var(--text); background:#e5f9f0;
    font-weight:700; font-size:16px; touch-action:manipulation;
    transition:transform .06s ease, border-color .15s, background .15s, box-shadow .15s;
  }
  button:active{transform:translateY(1px)}
  .primary{
    background:linear-gradient(90deg, var(--brand), var(--brand-2));
    border-color:transparent; color:#f8fafc;
    box-shadow:0 8px 24px rgba(34,197,94,.35);
  }
  .ghost{
    background:#ffffff;
    border-color:rgba(148,163,184,.7);
  }
  .ghost:hover{
    border-color:#22c55e;
    box-shadow:0 4px 12px rgba(15,23,42,.08);
  }
  .iconbtn{
    border:1px solid var(--border); background:#f8fafc; color:var(--text);
    border-radius:10px; padding:6px 9px; font-size:14px; min-height:auto
  }

  /* Cat√©gorie (segmented) */
  .category{display:grid; gap:8px; justify-items:center}
  .segmented{
    display:flex; gap:4px; padding:4px;
    border-radius:14px; background:#e2e8f0;
    border:1px solid var(--border)
  }
  .segmented button{
    border:none; background:transparent; padding:10px 16px;
    border-radius:10px; font-weight:800; color:#0f172a;
  }
  .segmented button.active{
    background:#ffffff;
    color:#16a34a;
    box-shadow:0 4px 10px rgba(15,23,42,.10);
  }
  .activePill{color:var(--muted); font-size:12px}

  /* Tableau t√¢ches */
  table.tasks{width:100%; border-collapse:collapse}
  .tasks th,.tasks td{border-bottom:1px solid var(--border); padding:10px; vertical-align:top}
  .tasks th{color:#0f172a; text-align:left; font-size:13px; background:#f9fafb}
  .task-title-wrap{display:flex; align-items:center; gap:10px; justify-content:space-between}
  .task-title{display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .actions{display:flex; gap:6px; margin-top:8px}
  .status{display:flex; gap:8px; flex-wrap:wrap}
  .status label{
    display:flex; align-items:center; gap:8px;
    padding:7px 10px; border:1px solid var(--border);
    border-radius:999px; font-size:13px; background:#f8fafc
  }
  .status input{accent-color:var(--brand); width:18px; height:18px}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.ok{background:var(--ok)}
  .dot.mid{background:var(--mid)}
  .dot.bad{background:var(--bad)}
  .dot.na{background:var(--na); outline:1px solid #ffffff66}

  .add-task{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
  .add-task input{flex:1 1 200px}

  /* LIGNE COMMENTAIRE SOUS CHAQUE T√ÇCHE */
  .comment-row td{
    background:#f9fafb;
    border-top:none;
  }
  .comment-row .comment-label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
    display:block;
  }
  .comment-row textarea{
    min-height:72px;
  }

  /* R√©sum√©/graph (FIXE, plac√© APR√àS les t√¢ches) */
  .summary{display:grid; grid-template-columns:1fr; gap:12px}
  .score{font-size:34px; font-weight:900; letter-spacing:.4px; color:#0f172a}
  .score-badge.good{color:var(--ok)!important}
  .score-badge.avg{color:var(--mid)!important}
  .score-badge.poor{color:var(--bad)!important}
  .legend{display:flex; gap:8px; flex-wrap:wrap}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid var(--border);
    border-radius:999px; color:var(--muted);
    background:#f8fafc; font-size:13px
  }
  .display-switch{display:flex; gap:6px; justify-content:center; margin-top:6px}
  .chart-box{width:100%; max-width:340px; margin-inline:auto}
  .chart-box canvas{width:100% !important; height:auto !important; aspect-ratio:1 / 1}

  /* Barres (fallback / alternatif) */
  .bars{display:flex; flex-direction:column; gap:10px; font-size:13px; color:var(--muted);}
  .bars .bar .top{display:flex; justify-content:space-between; margin-bottom:4px;}
  .bars .bar .track{
    width:100%; height:8px; border-radius:999px;
    background:#e2e8f0; overflow:hidden;
  }
  .bars .bar .fill{
    height:100%; border-radius:999px;
    transition:width .25s ease-out;
  }

  /* Photos */
  .photos-head{
    display:flex; justify-content:space-between; align-items:center;
    gap:8px; flex-wrap:wrap
  }
  .photos-grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  }
  .photo-card{
    position:relative; border:1px solid var(--border);
    border-radius:12px; overflow:hidden; background:#f8fafc;
  }
  .photo-card img{display:block; width:100%; height:110px; object-fit:cover}
  .photo-actions{
    position:absolute; top:6px; right:6px;
    display:flex; gap:6px;
  }
  .photo-actions button{
    min-height:auto; padding:6px 8px; font-size:12px;
    background:rgba(15,23,42,.60); color:#f9fafb; border-color:transparent;
  }
  .caption{border-top:1px solid var(--border); padding:8px; background:#ffffff}
  .caption input{
    width:100%; background:#f8fafc; border:1px solid var(--border);
    border-radius:10px; padding:6px 8px; color:var(--text); font-size:14px
  }

  /* Barre d‚Äôaction coll√©e */
  .sticky-actions{
    position:fixed; left:0; right:0; bottom:0;
    background:rgba(255,255,255,0.96);
    border-top:1px solid var(--border);
    padding:10px calc(12px + env(safe-area-inset-right))
            calc(10px + env(safe-area-inset-bottom))
            calc(12px + env(safe-area-inset-left));
    display:flex; gap:8px; justify-content:center;
    backdrop-filter:saturate(160%) blur(10px);
  }
  .sticky-actions > *{flex:1}
  @media (min-width:700px){
    .sticky-actions{position:static; padding:0; border:none; backdrop-filter:none}
    main{padding-bottom:24px}
  }

  @media print{
    .sticky-actions{display:none}
    body{background:#fff; color:#000}
    .card{border-color:#e5e7eb; box-shadow:none}
    header.hero{background:#fff}
  }

  /* ========= OPTIMISATIONS iPHONE / PETITS √âCRANS ========= */
  @media (max-width:600px){
    body{
      font-size:16px;
    }

    header.hero{
      padding:12px 10px 10px;
    }

    h1{
      font-size:20px;
    }

    .tagline{
      font-size:12px;
      padding:6px 10px;
    }

    main{
      max-width:100%;
      padding:10px 8px 96px;
    }

    .card{
      padding:10px 10px 12px;
      border-radius:14px;
    }

    .row{
      flex-direction:column;
    }
    .grow,
    .grow-lg{
      min-width:100%;
      flex:1 1 auto;
    }

    .task-title-wrap{
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
    }

    .task-title{
      white-space:normal;
    }

    .actions{
      margin-top:4px;
      align-self:flex-end;
    }

    .tasks th,
    .tasks td{
      padding:8px 6px;
      font-size:13px;
    }

    .status{
      flex-direction:column;
      align-items:flex-start;
    }

    .status label{
      width:100%;
      justify-content:flex-start;
    }

    .add-task{
      flex-direction:column;
    }

    .add-task button{
      width:100%;
    }

    .photos-head{
      flex-direction:column;
      align-items:flex-start;
    }

    .photos-head > div:last-child{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .photos-head button{
      flex:1 1 auto;
      font-size:14px;
      padding:8px 10px;
    }

    .sticky-actions{
      padding:8px 10px calc(8px + env(safe-area-inset-bottom));
      gap:6px;
    }

    .sticky-actions button{
      font-size:15px;
      padding:10px;
    }

    .chip{
      font-size:12px;
      padding:5px 8px;
    }

    .score{
      font-size:30px;
    }
  }

  @media (max-width:380px){
    main{
      padding:8px 6px 92px;
    }

    .card{
      padding:8px 8px 10px;
    }

    button{
      font-size:15px;
    }

    .photos-grid{
      grid-template-columns:repeat(2, minmax(0,1fr));
    }
  }
</style>
</head>
<body>

<header class="hero">
  <h1>Contr√¥le Qualit√© ‚Äì R√©sidence / Bureau</h1>
  <div class="tagline">Bloc ‚ÄúNote + Graphique‚Äù fixe et plac√© sous la liste des t√¢ches ‚Ä¢ PDF ‚Ä¢ Photos ‚Ä¢ Export/Import</div>
</header>

<main>
  <!-- Cat√©gorie -->
  <section class="card">
    <div class="category">
      <label class="lbl" id="catLbl">Cat√©gorie de contr√¥le</label>
      <div class="segmented" role="tablist" aria-labelledby="catLbl">
        <button id="btnResidence" class="active" role="tab" aria-selected="true">R√©sidence</button>
        <button id="btnBureau" role="tab" aria-selected="false">Bureau</button>
      </div>
      <span class="activePill" id="activeCategoryPill" aria-live="polite">Actif : R√©sidence</span>
    </div>
  </section>

  <!-- Infos g√©n√©rales -->
  <section class="card" aria-labelledby="infosLbl">
    <span id="infosLbl" class="lbl">Informations g√©n√©rales</span>
    <div class="row" role="group" aria-label="Date, heure et site">
      <div class="grow">
        <label class="lbl" for="date">Date</label>
        <input type="date" id="date" autocomplete="off">
      </div>
      <div class="grow">
        <label class="lbl" for="heure">Heure de contr√¥le</label>
        <input type="time" id="heure" autocomplete="off">
      </div>
      <div class="grow-lg">
        <label class="lbl" for="site">Site / R√©sidence / Entreprise</label>
        <input type="text" id="site" placeholder="Ex. R√©sidence Les Tilleuls / ACME SAS" autocomplete="off">
      </div>
    </div>
    <div class="row" style="margin-top:8px" role="group" aria-label="Agents et contr√¥leur">
      <div class="grow-lg">
        <label class="lbl" for="agents">Agent(s) de propret√© contr√¥l√©(s)</label>
        <input type="text" id="agents" placeholder="Ex. Dupont A., Martin L.">
      </div>
      <div class="grow">
        <label class="lbl" for="controleur">Contr√¥leur</label>
        <input type="text" id="controleur" placeholder="Votre nom">
      </div>
    </div>
  </section>

  <!-- T√¢ches -->
  <section class="card" id="tasksCard" aria-labelledby="tachesLbl">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
      <span id="tachesLbl" class="lbl">T√¢ches √† contr√¥ler</span>
      <span id="tasksCount" style="color:var(--muted); font-size:12px">0 t√¢che</span>
    </div>

    <table class="tasks" id="tasksTable" aria-describedby="score">
      <thead>
        <tr>
          <th scope="col" style="width:50%">T√¢che</th>
          <th scope="col" style="width:50%">Statut</th>
        </tr>
      </thead>
      <tbody id="tasksBody"></tbody>
    </table>

    <div class="add-task">
      <input id="newTaskInput" type="text" placeholder="Ajouter une t√¢che personnalis√©e‚Ä¶" />
      <button id="addTaskBtn" class="ghost" aria-label="Ajouter la t√¢che">Ajouter</button>
      <button id="clearAllBtn" class="ghost" aria-label="R√©initialiser les donn√©es">R√©initialiser</button>
      <button id="exportBtn" class="ghost" title="Exporter en JSON">Exporter</button>
      <button id="importBtn" class="ghost" title="Importer depuis JSON">Importer</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </section>

  <!-- ===== BLOC NOTE & GRAPHIQUE (FIXE, EN DESSOUS DES T√ÇCHES) ===== -->
  <section class="card" id="summaryCard">
    <div class="summary">
      <div>
        <label class="lbl">Note de qualit√©</label>
        <div class="score"><span id="score" class="score-badge" aria-live="polite">‚Äî</span></div>
        <!-- Phrase demand√©e sous la note globale -->
        <div style="font-size:13px; color:var(--muted); margin-top:4px;">
          La moyenne de r√©f√©rence cible est de 95%
        </div>
        <div class="legend" style="margin-top:8px">
          <span class="chip"><span class="dot ok"></span>Bien fait</span>
          <span class="chip"><span class="dot mid"></span>Passable</span>
          <span class="chip"><span class="dot bad"></span>Mal fait</span>
          <span class="chip"><span class="dot na"></span>Pas faits</span>
        </div>
      </div>

      <div>
        <div class="display-switch" role="group" aria-label="Type d'affichage">
          <button class="ghost" id="viewPie" aria-pressed="true">Camembert</button>
          <button class="ghost" id="viewBars" aria-pressed="false">Barres</button>
        </div>

        <!-- Camembert -->
        <div class="chart-box" id="pieWrap" style="margin-top:10px">
          <canvas id="pieChart" aria-label="Camembert qualit√©" role="img"></canvas>
          <div id="pieFallback" style="display:none; color:var(--muted); font-size:13px; text-align:center; margin-top:8px">
            Camembert indisponible. Affichage ¬´ Barres ¬ª activ√©.
          </div>
        </div>

        <!-- Barres (fallback / alternative) -->
        <div class="chart-box" id="barsWrap" style="display:none; margin-top:10px">
          <div class="bars" id="barsChart"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Observations -->
  <section class="card">
    <label class="lbl" for="obs">Observations g√©n√©rales / actions correctives</label>
    <textarea id="obs" placeholder="Ex. Repassage des parties communes demain 9h, commande de consommables‚Ä¶"></textarea>
  </section>

  <!-- Photos -->
  <section class="card" id="photosCard">
    <div class="photos-head">
      <div>
        <strong>Photos du chantier</strong>
        <div style="color:var(--muted); font-size:12px" id="photosCount">0 photo</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="ghost" id="btnPick">Ajouter depuis la pellicule</button>
        <button class="ghost" id="btnCapture">Prendre une photo</button>
        <button class="ghost" id="btnClearPhotos">Tout retirer</button>
      </div>
    </div>

    <input id="filePicker" type="file" accept="image/*" multiple style="display:none" />
    <input id="fileCapture" type="file" accept="image/*" capture="environment" style="display:none" />
    <div class="photos-grid" id="photosGrid"></div>
  </section>
</main>

<!-- Barre d‚Äôaction -->
<div class="sticky-actions">
  <button class="primary" id="pdfBtn">G√©n√©rer un PDF</button>
</div>

<!-- Librairies -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
/* ============================================================
   Contr√¥le Qualit√© ‚Äì Bloc NOTE fixe sous les t√¢ches
   Persistance locale, export/import JSON, PDF avec photos,
   fallback charts, visibilit√© ‚ÄúPas faits‚Äù.
   Th√®me adapt√© (clair + vert), commentaires sous chaque t√¢che.
   Bouton "R√©initialiser" = t√¢ches + infos g√©n√©rales.
   ============================================================ */
(function(){
  /* ===== Donn√©es & constantes ===== */
  const DEFAULTS = {
    Residence: [
      "Nettoyage platine et digicode","vitrerie et miroiterie lavage racletteet mouilleur","Vitrerie et miroiterie enlevement des traces de doigts","Nettoyage des encadrements des vitres et montant porte d'entr√©e",
      "Enroulement des tapis","Aspirations des sols","Lavage des sols","Aspirations des escaliers de services","Lavage des escaliers de services","Enlevement des toiles d'araign√©es","Nettoyage des rampes et gardes corps","Nettoyages porte de services",
      "Nettoyage des portes des gaines technique","Depoussierage ou nettoyage des plinthes","Nettoyage boites aux lettres","Vidage des corbeilles","Mise en poches des corbeilles","Acc√®s sous sol","Ramassage des dechets dans le parking","Nettoyage des fa√ßade ascenseur","Nettoyage des tranches lat√©rales des ascenseurs",
      "Nettoyage des fa√ßade interieures des ascenceurs","Nettoyage rails ascenceurs","Nettoyages plaque de commande","Rentr√©e conteneurs","Sortie conteneurs","Nettoyage conteneurs","Lavage local poubelle"
    ],
    Bureau: [
      "Accueil ‚Äì comptoir & sol","Bureaux ‚Äì surfaces & √©crans hors tension","Sols ‚Äì aspiration / lavage",
      "Sanitaires ‚Äì cuvettes, lavabos, distributeurs","Cuisine / kitchenette ‚Äì plans & √©viers",
      "Salles de r√©union ‚Äì tables & chaises","Poubelles ‚Äì vidage & tri","Vitres & vitrines accessibles",
      "Poign√©es & points de contact","R√©assort consommables (essuie-mains, savon‚Ä¶)"
    ]
  };
  const STATUS_LABEL = { ok:"BIEN FAIT", mid:"PASSABLE", bad:"MAL FAIT", na:"PAS FAITS" };
  const LS_KEY = "cq_app_state_bottomnote_v1";

  /* ===== DOM helpers ===== */
  const $ = id => document.getElementById(id);
  const els = {
    btnResidence: $('btnResidence'), btnBureau: $('btnBureau'), activePill: $('activeCategoryPill'),
    date: $('date'), heure: $('heure'), site: $('site'), agents: $('agents'), controleur: $('controleur'), obs: $('obs'),

    // r√©sum√©/graph
    score: $('score'), viewPie: $('viewPie'), viewBars: $('viewBars'),
    pieWrap: $('pieWrap'), barsWrap: $('barsWrap'), pieCanvas: $('pieChart'), pieFallback: $('pieFallback'),
    barsChart: $('barsChart'),

    // t√¢ches
    tasksBody: $('tasksBody'), tasksCount: $('tasksCount'),
    newTaskInput: $('newTaskInput'), addTaskBtn: $('addTaskBtn'), clearAllBtn: $('clearAllBtn'),
    exportBtn: $('exportBtn'), importBtn: $('importBtn'), importFile: $('importFile'),

    // photos
    photosGrid: $('photosGrid'), photosCount: $('photosCount'),
    btnPick: $('btnPick'), btnCapture: $('btnCapture'), btnClearPhotos: $('btnClearPhotos'),
    filePicker: $('filePicker'), fileCapture: $('fileCapture'),

    // pdf
    pdfBtn: $('pdfBtn')
  };

  /* ===== √âtat ===== */
  const saved = loadState();
  const state = saved || {
    category: 'Residence',
    dataByCategory: {
      Residence: DEFAULTS.Residence.map(n=>({id:uid(), name:n, status:'', comment:''})),
      Bureau:    DEFAULTS.Bureau.map(n=>({id:uid(), name:n, status:'', comment:''}))
    },
    display: 'pie',
    chartReady: false,
    photos: [],
    form: { date:'', heure:'', site:'', agents:'', controleur:'', obs:'' }
  };

  if(!state.photos) state.photos = [];
  if(!state.form) state.form = { date:'', heure:'', site:'', agents:'', controleur:'', obs:'' };

  let pieChart = null;

  /* ===== Utils ===== */
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function saveState(){
    try{
      const persist = {
        category: state.category,
        dataByCategory: state.dataByCategory,
        display: state.display,
        photos: state.photos || [],
        form: {
          date: els.date.value || '', heure: els.heure.value || '',
          site: els.site.value || '', agents: els.agents.value || '',
          controleur: els.controleur.value || '', obs: els.obs.value || ''
        }
      };
      localStorage.setItem(LS_KEY, JSON.stringify(persist));
    }catch(e){}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }

  /* ===== Init ===== */
  document.addEventListener('DOMContentLoaded', init);
  function init(){
    // Form restore
    els.date.value = state.form?.date || todayISO();
    els.heure.value = state.form?.heure || '';
    els.site.value = state.form?.site || '';
    els.agents.value = state.form?.agents || '';
    els.controleur.value = state.form?.controleur || '';
    els.obs.value = state.form?.obs || '';

    // Cat√©gorie
    els.btnResidence.addEventListener('click', ()=>switchCategory('Residence'));
    els.btnBureau.addEventListener('click', ()=>switchCategory('Bureau'));

    // T√¢ches
    els.addTaskBtn.addEventListener('click', addTaskFromInput);
    els.newTaskInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addTaskFromInput(); }});
    els.clearAllBtn.addEventListener('click', resetAll);

    // Export / Import
    els.exportBtn.addEventListener('click', exportJSON);
    els.importBtn.addEventListener('click', ()=> els.importFile.click());
    els.importFile.addEventListener('change', importJSON);

    // Heure auto si vide au changement de date/site
    [els.date, els.site].forEach(el=>{
      el.addEventListener('change', ()=>{
        if(!els.heure.value){
          const d=new Date();
          els.heure.value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
          saveState();
        }
      });
    });

    // Sauvegarde champs
    [els.date, els.heure, els.site, els.agents, els.controleur, els.obs].forEach(el=>{
      el.addEventListener('input', saveState);
      el.addEventListener('change', saveState);
    });

    // Affichage graph
    els.viewPie.addEventListener('click', ()=>{ setDisplay('pie'); updateScoreAndVisuals(); saveState(); });
    els.viewBars.addEventListener('click', ()=>{ setDisplay('bars'); updateScoreAndVisuals(); saveState(); });

    // Photos
    els.btnPick.addEventListener('click', ()=> els.filePicker.click());
    els.btnCapture.addEventListener('click', ()=> els.fileCapture.click());
    els.btnClearPhotos.addEventListener('click', clearAllPhotos);
    els.filePicker.addEventListener('change', async (e)=>{ await handleFiles(e.target.files); e.target.value=''; });
    els.fileCapture.addEventListener('change', async (e)=>{ await handleFiles(e.target.files); e.target.value=''; });

    // PDF
    els.pdfBtn.addEventListener('click', generatePDF);

    // Charts + rendu
    setupCharts();
    switchCategory(state.category);
    setDisplay(state.display || 'pie');
    updateScoreAndVisuals();
    renderPhotos();
  }

  /* ===== Cat√©gorie & t√¢ches ===== */
  function currentTasks(){ return state.dataByCategory[state.category]; }
  function setTasks(tasks){ state.dataByCategory[state.category] = tasks; saveState(); }

  function switchCategory(cat){
    state.category = cat; saveState();
    els.btnResidence.classList.toggle('active', cat==='Residence');
    els.btnResidence.setAttribute('aria-selected', cat==='Residence');
    els.btnBureau.classList.toggle('active', cat==='Bureau');
    els.btnBureau.setAttribute('aria-selected', cat==='Bureau');
    $('activeCategoryPill').textContent = `Actif : ${cat==='Residence'?'R√©sidence':'Bureau'}`;
    renderTasks();
    updateScoreAndVisuals();
  }

  function renderTasks(){
    els.tasksBody.innerHTML = '';
    const tasks = currentTasks();
    els.tasksCount.textContent = `${tasks.length} t√¢che${tasks.length>1?'s':''}`;

    tasks.forEach(t=>{
      // Ligne principale : t√¢che + statut
      const tr = document.createElement('tr'); tr.dataset.taskId = t.id;

      // Nom + actions
      const tdName = document.createElement('td');
      const wrap = document.createElement('div'); wrap.className='task-title-wrap';
      const span = document.createElement('span'); span.textContent = t.name; span.className='task-title';
      const actions = document.createElement('div'); actions.className='actions';
      const editBtn = document.createElement('button'); editBtn.className='iconbtn'; editBtn.title='Renommer'; editBtn.textContent='‚úé';
      const delBtn = document.createElement('button'); delBtn.className='iconbtn'; delBtn.title='Supprimer'; delBtn.textContent='üóë';

      editBtn.addEventListener('click', ()=>{
        const val = prompt("Renommer la t√¢che :", t.name);
        if(val && val.trim()){
          t.name = val.trim();
          span.textContent = t.name;
          saveState();
          updateScoreAndVisuals();
        }
      });
      delBtn.addEventListener('click', ()=>{ deleteTask(t.id); });

      actions.appendChild(editBtn); actions.appendChild(delBtn);
      wrap.appendChild(span); wrap.appendChild(actions);
      tdName.appendChild(wrap);
      tr.appendChild(tdName);

      // Statut
      const tdStatus = document.createElement('td');
      tdStatus.appendChild(buildStatusGroup(t));
      tr.appendChild(tdStatus);

      els.tasksBody.appendChild(tr);

      // Ligne commentaire sous la t√¢che (colspan 2)
      const trComment = document.createElement('tr');
      trComment.className = 'comment-row';
      const tdComment = document.createElement('td');
      tdComment.colSpan = 2;

      const lbl = document.createElement('span');
      lbl.className = 'comment-label';
      lbl.textContent = "Commentaire (optionnel)";

      const ta = document.createElement('textarea');
      ta.placeholder = "Ajouter un commentaire‚Ä¶";
      ta.value = t.comment || '';
      ta.addEventListener('input', e=>{
        t.comment = e.target.value;
        saveState();
      });

      tdComment.appendChild(lbl);
      tdComment.appendChild(ta);
      trComment.appendChild(tdComment);

      els.tasksBody.appendChild(trComment);
    });
  }

  function buildStatusGroup(task){
    const wrap = document.createElement('div'); wrap.className='status';
    ["ok","mid","bad","na"].forEach(key=>{
      const id = `${task.id}_${key}`;
      const lbl = document.createElement('label');
      const dotClass = key==='ok'?'ok':key==='mid'?'mid':key==='bad'?'bad':'na';
      lbl.innerHTML =
        `<input type="radio" name="st_${task.id}" id="${id}" value="${key}" ${task.status===key?'checked':''}>
         <span class="dot ${dotClass}"></span>${STATUS_LABEL[key]}`;
      wrap.appendChild(lbl);
    });
    wrap.addEventListener('change', ()=>{
      const checked = wrap.querySelector(`input[name="st_${task.id}"]:checked`);
      task.status = checked ? checked.value : '';
      updateScoreAndVisuals();
      saveState();
    });
    return wrap;
  }

  function deleteTask(id){
    setTasks(currentTasks().filter(x=>x.id!==id));
    renderTasks();
    updateScoreAndVisuals();
  }

  function addTaskFromInput(){
    const v = els.newTaskInput.value.trim(); if(!v) return;
    const exists = currentTasks().some(t=>t.name.toLowerCase()===v.toLowerCase());
    if(exists){ alert("Cette t√¢che existe d√©j√†."); return; }
    currentTasks().push({id:uid(), name:v, status:'', comment:''});
    els.newTaskInput.value = '';
    renderTasks();
    updateScoreAndVisuals();
    els.newTaskInput.focus({preventScroll:true});
    saveState();
  }

  function resetAll(){
    if(!confirm("R√©initialiser les donn√©es (t√¢ches + informations g√©n√©rales) pour cette cat√©gorie ?")) return;

    // 1) R√©initialiser les t√¢ches de la cat√©gorie
    const defaults = (state.category==='Residence'? DEFAULTS.Residence : DEFAULTS.Bureau)
      .map(n=>({id:uid(), name:n, status:'', comment:''}));
    state.dataByCategory[state.category] = defaults;

    // 2) R√©initialiser les informations g√©n√©rales
    els.date.value       = todayISO();
    els.heure.value      = '';
    els.site.value       = '';
    els.agents.value     = '';
    els.controleur.value = '';
    els.obs.value        = '';

    state.form = {
      date: els.date.value,
      heure: els.heure.value,
      site: els.site.value,
      agents: els.agents.value,
      controleur: els.controleur.value,
      obs: els.obs.value
    };

    // 3) Sauvegarder + re-render
    saveState();
    renderTasks();
    updateScoreAndVisuals();
  }

  /* ===== Export / Import JSON ===== */
  function exportJSON(){
    const out = {
      meta: { app:"controle-qualite", version:1, exportedAt:new Date().toISOString() },
      state: JSON.parse(localStorage.getItem(LS_KEY) || "{}")
    };
    const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeSite = (els.site.value || 'site').replace(/[^a-z0-9\- _]/gi,'_').replace(/\s+/g,'_');
    a.download = `CQ_${state.category==='Residence'?'Residence':'Bureau'}_${safeSite}_${els.date.value||''}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(e){
    const file = e.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!data?.state?.dataByCategory) throw new Error("Format invalide");
        state.category       = data.state.category || 'Residence';
        state.dataByCategory = data.state.dataByCategory;
        state.display        = data.state.display || 'pie';
        state.photos         = data.state.photos || [];

        // formulaire
        els.date.value       = data.state.form?.date || todayISO();
        els.heure.value      = data.state.form?.heure || '';
        els.site.value       = data.state.form?.site || '';
        els.agents.value     = data.state.form?.agents || '';
        els.controleur.value = data.state.form?.controleur || '';
        els.obs.value        = data.state.form?.obs || '';

        state.form = {
          date: els.date.value,
          heure: els.heure.value,
          site: els.site.value,
          agents: els.agents.value,
          controleur: els.controleur.value,
          obs: els.obs.value
        };

        saveState();
        switchCategory(state.category);
        setDisplay(state.display);
        renderPhotos();
        alert("Import r√©ussi.");
      }catch(err){
        alert("Import impossible : " + err.message);
      }finally{
        e.target.value='';
      }
    };
    reader.readAsText(file);
  }

  /* ===== Calculs & Affichages ===== */
  function computeMetrics(){
    const tasks = currentTasks();

    // On ne prend en compte que les t√¢ches qui ont une entr√©e de statut
    const rated = tasks.filter(t =>
      t.status === 'ok' || t.status === 'mid' || t.status === 'bad' || t.status === 'na'
    );

    const totalPossible = rated.length * 3;
    let nOK = 0, nMID = 0, nBAD = 0, nNA = 0;

    rated.forEach(t=>{
      if(t.status === 'ok')      nOK++;
      else if(t.status === 'mid') nMID++;
      else if(t.status === 'bad') nBAD++;
      else if(t.status === 'na')  nNA++;
    });

    const totalGot = (nOK * 3) + (nMID * 1); // coefficients inchang√©s
    const pct = totalPossible > 0 ? Math.round((totalGot / totalPossible) * 100) : NaN;

    const total = rated.length; // pour les barres, m√™me logique : uniquement les t√¢ches renseign√©es

    return { pct, nOK, nMID, nBAD, nNA, total };
  }

  function updateScoreAndVisuals(){
    const { pct, nOK, nMID, nBAD, nNA, total } = computeMetrics();
    els.score.textContent = isFinite(pct) ? `${pct}%` : '‚Äî';
    els.score.className = 'score-badge ' + (isFinite(pct) ? (pct>=85?'good':(pct>=65?'avg':'poor')) : '');

    if(state.chartReady && pieChart){
      pieChart.data.datasets[0].data = [nOK, nMID, nBAD, nNA];
      pieChart.update();
    }
    drawBars({nOK,nMID,nBAD,nNA,total});
  }

  /* ===== Charts ===== */
  function setupCharts(){
    if(!window.Chart || !('Chart' in window)){
      state.chartReady = false;
      els.pieFallback.style.display = '';
      setDisplay('bars');
      return;
    }
    const colors = [
      cssVar('--ok')||'#16a34a',
      cssVar('--mid')||'#f59e0b',
      cssVar('--bad')||'#dc2626',
      cssVar('--na')||'#000000'
    ];
    const ctx = els.pieCanvas.getContext('2d');
    pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Bien fait','Passable','Mal fait','Pas faits'],
        datasets: [{
          data:[0,0,0,0],
          backgroundColor: colors,
          borderColor:'#ffffff',
          borderWidth:1
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:true,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              label:(c)=>{
                const total = c.dataset.data.reduce((a,b)=>a+b,0) || 1;
                const v=c.raw; const p=Math.round((v/total)*100);
                return `${c.label}: ${v} t√¢che(s) (${p}%)`;
              }
            }
          }
        }
      }
    });
    state.chartReady = true;
    els.pieFallback.style.display = 'none';
  }

  function setDisplay(mode){
    state.display = mode;
    els.viewPie.setAttribute('aria-pressed', mode==='pie');
    els.viewBars.setAttribute('aria-pressed', mode==='bars');
    els.pieWrap.style.display  = (mode==='pie'  && state.chartReady) ? '' : 'none';
    els.barsWrap.style.display = (mode==='bars' || !state.chartReady) ? '' : 'none';
  }

  function drawBars({nOK,nMID,nBAD,nNA,total}){
    const data = [
      {label:'Bien fait', value:nOK, color:cssVar('--ok')||'#16a34a'},
      {label:'Passable', value:nMID, color:cssVar('--mid')||'#f59e0b'},
      {label:'Mal fait', value:nBAD, color:cssVar('--bad')||'#dc2626'},
      {label:'Pas faits', value:nNA, color:cssVar('--na')||'#000000', outline:true}
    ];
    els.barsChart.innerHTML = '';
    data.forEach(d=>{
      const pct = total ? Math.round((d.value/total)*100) : 0;
      const row = document.createElement('div'); row.className='bar';
      row.innerHTML = `
        <div class="top"><span>${d.label}</span><span>${d.value} / ${total} (${pct}%)</span></div>
        <div class="track"><div class="fill" style="width:${pct}%; background:${d.color}; ${d.outline?'outline:1px solid #ffffff66; box-shadow:inset 0 0 0 1px #ffffff33':''}"></div></div>
      `;
      els.barsChart.appendChild(row);
    });
  }

  /* ===== Photos ===== */
  async function handleFiles(fileList){
    if(!fileList || !fileList.length) return;
    for(const file of fileList){
      if(!file.type.startsWith('image/')) continue;
      const dataUrl = await compressImageToDataURL(file, 1600, 0.85);
      state.photos.push({id:uid(), dataUrl, name:file.name || 'photo', caption:''});
    }
    renderPhotos();
    saveState();
  }

  function clearAllPhotos(){
    if(!state.photos.length) return;
    if(!confirm('Retirer toutes les photos ?')) return;
    state.photos = [];
    renderPhotos();
    saveState();
  }

  function renderPhotos(){
    els.photosGrid.innerHTML = '';
    state.photos.forEach(ph=>{
      const card = document.createElement('div'); card.className='photo-card'; card.dataset.pid = ph.id;
      card.innerHTML = `
        <img alt="Photo ajout√©e" src="${ph.dataUrl}">
        <div class="photo-actions">
          <button class="iconbtn" title="Supprimer" aria-label="Supprimer">üóë</button>
        </div>
        <div class="caption">
          <input type="text" placeholder="L√©gende (optionnel)" value="${escapeHtml(ph.caption||'')}">
        </div>
      `;
      card.querySelector('.iconbtn').addEventListener('click', ()=>{
        removePhoto(ph.id);
      });
      card.querySelector('.caption input').addEventListener('input', (e)=>{
        ph.caption = e.target.value;
        saveState();
      });
      els.photosGrid.appendChild(card);
    });
    els.photosCount.textContent = `${state.photos.length} photo${state.photos.length>1?'s':''}`;
  }

  function removePhoto(id){
    state.photos = state.photos.filter(p=>p.id!==id);
    renderPhotos();
    saveState();
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function compressImageToDataURL(file, maxDim=1600, quality=0.85){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onerror = ()=>reject(new Error('Lecture image √©chou√©e'));
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const {width, height} = img;
          let w = width, h = height;
          if(w>h && w>maxDim){ h = Math.round(h*(maxDim/w)); w = maxDim; }
          else if(h>=w && h>maxDim){ w = Math.round(w*(maxDim/h)); h = maxDim; }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          try{
            const url = canvas.toDataURL('image/jpeg', quality);
            resolve(url);
          }catch(e){ resolve(reader.result); }
        };
        img.onerror = ()=>reject(new Error('D√©codage image √©chou√©'));
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  /* ===== PDF ===== */
  async function generatePDF(){
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF || !window.jspdf || !('autoTable' in (jsPDF.API||{}))){
      alert("Erreur: librairies PDF non charg√©es (jsPDF / AutoTable). V√©rifiez le r√©seau.");
      return;
    }
    const data = {
      date: els.date.value || '', heure: els.heure.value || '', site: els.site.value || '',
      agents: els.agents.value || '', controleur: els.controleur.value || '',
      obs: (els.obs.value || '').trim(), category: state.category==='Residence'?'R√©sidence':'Bureau'
    };
    const rows = currentTasks().map(t=>[ t.name, STATUS_LABEL[t.status || ''] || '', t.comment||'' ]);

    const metrics = computeMetrics();
    const doc = new jsPDF({unit:'pt', format:'a4'}), margin = 36, lineH = 16, pageW = 595, pageH = 842;

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    doc.text(`Contr√¥le Qualit√© ‚Äì ${data.category}`, margin, 42);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    [
      `Date : ${data.date || '-'}`,
      `Heure : ${data.heure || '-'}`,
      `Site : ${data.site || '-'}`,
      `Contr√¥leur : ${data.controleur || '-'}`,
      `Agent(s) : ${data.agents || '-'}`
    ].forEach((t,i)=> doc.text(t, margin, 66 + i*lineH));

    // Note + visuel
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    doc.text(`Note : ${isFinite(metrics.pct)?metrics.pct+'%':'‚Äî'}`, margin, 66 + 5*lineH + 22);

    let haveChartImage = false;
    try{
      if(state.chartReady && els.pieCanvas){
        const dataUrl = els.pieCanvas.toDataURL('image/png', 1.0);
        if(dataUrl && dataUrl.startsWith('data:image')){
          doc.addImage(dataUrl, 'PNG', 360, 40, 200, 200);
          haveChartImage = true;
        }
      }
    }catch(e){}
    if(!haveChartImage){
      const recap = [
        `Bien fait : ${metrics.nOK}`, `Passable : ${metrics.nMID}`,
        `Mal fait : ${metrics.nBAD}`, `Pas faits : ${metrics.nNA}`
      ];
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      recap.forEach((t,i)=> doc.text(t, 360, 60 + i*14));
    }

    // Tableau des t√¢ches
    doc.autoTable({
      startY: 260,
      head: [['T√¢che','Statut','Commentaire']],
      body: rows,
      styles:{ font:'helvetica', fontSize:9, cellPadding:4, overflow:'linebreak' },
      headStyles:{ fillColor:[15,118,110], textColor:[248,250,252] },
      columnStyles:{ 0:{cellWidth:260}, 1:{cellWidth:110}, 2:{cellWidth:145} },
      margin: {left: margin, right: margin}
    });

    // Observations
    let y = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 520;
    doc.setFont('helvetica','bold'); doc.setFontSize(11);
    doc.text('Observations / actions correctives :', margin, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const split = doc.splitTextToSize(data.obs || '‚Äî', pageW - margin*2);
    doc.text(split, margin, y+16);

    // Signatures
    y = (doc.lastAutoTable ? doc.lastAutoTable.finalY : y) + 120;
    const sigTop = Math.max(y, 720), boxW = (pageW - margin*2 - 18)/2, boxH = 100;
    doc.setDrawColor(180); doc.setLineWidth(0.8);
    doc.rect(margin, sigTop, boxW, boxH);
    doc.setFont('helvetica','bold');
    doc.text('Signature Contr√¥leur', margin+10, sigTop+18);
    doc.setFont('helvetica','normal');
    doc.text('Nom, date et signature', margin+10, sigTop+36);

    doc.rect(margin+boxW+18, sigTop, boxW, boxH);
    doc.setFont('helvetica','bold');
    doc.text('Signature Agent', margin+boxW+28, sigTop+18);
    doc.setFont('helvetica','normal');
    doc.text('Nom, date et signature', margin+boxW+28, sigTop+36);

    /* ===== Page Photos ===== */
    if(state.photos.length){
      doc.addPage();
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Photos du chantier', margin, 42);
      const cols = 2, gap = 14;
      const cellW = Math.floor((pageW - margin*2 - gap*(cols-1)) / cols);
      const imgH = Math.round(cellW * 0.75); // 4:3
      const capH = 40;

      let cx = margin, cy = 64;

      for(let i=0; i<state.photos.length; i++){
        const ph = state.photos[i];
        if(cy + imgH + capH > pageH - margin){
          doc.addPage(); cx = margin; cy = 42;
        }
        try{
          doc.addImage(ph.dataUrl, 'JPEG', cx, cy, cellW, imgH);
        }catch(e){}
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        const cap = ph.caption ? `${ph.caption}` : '';
        if(cap){
          const capLines = doc.splitTextToSize(cap, cellW);
          doc.text(capLines, cx, cy + imgH + 14);
        }
        if((i % cols) === cols-1){ cx = margin; cy += imgH + capH; }
        else { cx += cellW + gap; }
      }
    }

    const safeSite = (data.site || 'site').replace(/[^a-z0-9\- _]/gi,'_');
    const filename = `Controle_Qualite_${data.category}_${safeSite}_${data.date||''}.pdf`.replace(/\s+/g,'_');
    doc.save(filename);
  }

})();
</script>
</body>
</html>

