<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>KONTROL ‚Äì Dossier Agent & Suivi</title>

  <!-- iPhone friendly -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#16a34a">

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; }

    :root{
      /* TH√àME CLAIR (style KONTROL) */
      --bg:#f1f5f9;
      --panel:#ffffff;
      --panel2:#f8fafc;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(148,163,184,.35);
      --brand:#16a34a;
      --brand2:#22c55e;

      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;

      --shadow: 0 18px 45px rgba(2,6,23,.10);
      --shadow2: 0 10px 26px rgba(2,6,23,.08);
      --r12:12px;
      --r14:14px;
      --r16:16px;
      --r20:20px;

      --focus: 0 0 0 3px rgba(34,197,94,.22);
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(59,130,246,.08), transparent 55%),
        radial-gradient(800px 600px at 60% 120%, rgba(239,68,68,.06), transparent 55%),
        linear-gradient(180deg, #f8fafc, var(--bg));
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:10;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(241,245,249,.96), rgba(241,245,249,.78));
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .logo{
      width:40px; height:40px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.0) 55%),
        linear-gradient(135deg, rgba(34,197,94,.98), rgba(22,163,74,.70));
      box-shadow: 0 14px 30px rgba(22,163,74,.20);
      border: 1px solid rgba(22,163,74,.25);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .titles{ line-height:1.05; }
    .titles .t1{ font-weight:900; letter-spacing:.2px; font-size:15px; }
    .titles .t2{ color:var(--muted); font-weight:700; font-size:12px; margin-top:3px; }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: var(--r14);
      font-weight:800;
      font-size: 13px;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{ background: #ffffff; border-color: rgba(148,163,184,.55); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.98), rgba(22,163,74,.78));
      border-color: rgba(22,163,74,.28);
      color: #ffffff;
      box-shadow: 0 14px 28px rgba(22,163,74,.22);
    }
    .btn.primary:hover{ filter: brightness(1.02); }

    .btn.danger{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.25);
    }
    .btn.warn{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.25);
    }
    .btn.small{
      padding: 8px 10px;
      border-radius: 12px;
      font-size:12px;
      font-weight:900;
    }

    /* Content layout */
    .content{
      height:100%;
      display:flex;
      gap:12px;
      padding:12px;
      max-width:1200px;
      width:100%;
      margin:0 auto;
      overflow:hidden;
    }

    .sidebar{
      width: 350px;
      min-width: 290px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r20);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .side-head{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
    }

    .search{ display:flex; gap:8px; align-items:center; }

    .input{
      width:100%;
      padding: 11px 12px;
      border-radius: var(--r14);
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-weight:700;
      font-size: 13px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .input::placeholder{ color: rgba(100,116,139,.85); }
    .input:focus{ box-shadow: var(--focus); border-color: rgba(34,197,94,.45); }

    .side-meta{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .list{
      padding: 10px;
      overflow:auto;
      flex: 1;
    }

    .agent-card{
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 16px;
      padding: 10px 10px;
      margin-bottom: 10px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(2,6,23,.05);
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .agent-card:hover{ border-color: rgba(148,163,184,.60); }
    .agent-card:active{ transform: translateY(1px); }
    .agent-card.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.08);
      box-shadow: 0 14px 28px rgba(22,163,74,.12);
    }

    .agent-line1{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .agent-name{ font-weight: 900; font-size: 14px; letter-spacing:.1px; }
    .agent-sub{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
    }
    .dot{ opacity:.65; }

    .badges{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      font-size: 11px;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.03);
      color: var(--text);
      white-space:nowrap;
    }
    .badge.brand{ border-color: rgba(22,163,74,.28); background: rgba(34,197,94,.12); }
    .badge.warn{ border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.12); }
    .badge.danger{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.12); }

    .main{
      flex:1;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r20);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }

    .main-head{
      padding: 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      flex-wrap:wrap;
    }

    .main-title{ display:flex; flex-direction:column; gap:4px; min-width:240px; }
    .main-title h1{ margin:0; font-size:16px; font-weight: 900; letter-spacing:.2px; }
    .main-title p{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
      line-height: 1.25;
      max-width: 760px;
    }

    .main-tools{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-left:auto; }

    .scroll{ padding: 12px; overflow:auto; flex:1; }

    /* Panels / forms */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .panel{
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    details.panel > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(2,6,23,.02);
      user-select:none;
    }
    details.panel > summary::-webkit-details-marker { display:none; }
    .chev{ opacity:.7; font-weight: 900; transition: transform .12s ease; }
    details[open] .chev{ transform: rotate(180deg); }

    .panel-body{ padding: 12px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row.one{ grid-template-columns: 1fr; }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin: 0 0 6px 2px;
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: var(--r14);
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-weight: 700;
      font-size: 13px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .field textarea{ min-height: 92px; resize: vertical; }
    .field input:focus, .field select:focus, .field textarea:focus{
      box-shadow: var(--focus);
      border-color: rgba(34,197,94,.45);
    }

    .hint{
      margin-top: 6px;
      color: rgba(100,116,139,.95);
      font-size: 12px;
      font-weight: 700;
      line-height: 1.25;
    }

    .split{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }

    .hr{
      height:1px;
      background: rgba(148,163,184,.25);
      margin: 12px 0;
    }

    /* Incidents */
    .incident-form{
      border: 1px solid var(--border);
      background: rgba(2,6,23,.015);
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .incident-list{ display:flex; flex-direction:column; gap: 10px; }

    .incident{
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow2);
    }

    .incident-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .incident-title{ display:flex; flex-direction:column; gap:4px; }
    .incident-title .line{ font-weight: 900; letter-spacing:.2px; font-size: 14px; }
    .incident-title .meta{ color: var(--muted); font-weight: 750; font-size: 12px; line-height: 1.25; }

    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.03);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.12); }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
    .pill.danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }

    .incident-body{
      margin-top: 10px;
      color: rgba(15,23,42,.95);
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .incident-actions{ margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }

    .attach{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 750;
    }
    .attach a{
      color: rgba(22,163,74,.98);
      font-weight: 900;
      text-decoration:none;
    }
    .attach a:hover{ text-decoration:underline; }

    /* Empty */
    .empty{
      border: 1px dashed rgba(148,163,184,.55);
      background: rgba(255,255,255,.70);
      border-radius: 18px;
      padding: 16px;
      color: var(--muted);
      font-weight: 750;
      line-height: 1.35;
    }

    /* Mobile */
    @media (max-width: 980px){
      body{ overflow:auto; }
      .content{ flex-direction:column; height:auto; overflow:visible; }
      .sidebar{ width:100%; min-width: 0; }
      .main{ width:100%; }
      .grid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 1fr; }
      .brand{ min-width: 0; }
    }

    /* Print */
    @media print{
      body{ background:#fff !important; overflow:visible; }
      .topbar, .sidebar{ display:none !important; }
      .content{ padding:0; max-width:none; }
      .main{ box-shadow:none; border:none; border-radius:0; }
      .scroll{ overflow:visible; }
      .btn{ display:none !important; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2l8 4v6c0 5-3.2 9.4-8 10-4.8-.6-8-5-8-10V6l8-4Z" stroke="white" stroke-width="2" />
              <path d="M8 12l2.4 2.4L16 8.8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="titles">
            <div class="t1">KONTROL ‚Äì Dossier Agent</div>
            <div class="t2">Fiche + suivi comportement / incidents (local, offline)</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnNewAgent" title="Cr√©er un nouvel agent">Ôºã Nouvel agent</button>
          <button class="btn" id="btnExport" title="Exporter toutes les donn√©es">‚¨áÔ∏è Export JSON</button>
          <button class="btn" id="btnImport" title="Importer des donn√©es">‚¨ÜÔ∏è Import JSON</button>
          <button class="btn warn" id="btnPrint" title="Imprimer / enregistrer en PDF via le navigateur">üñ®Ô∏è Imprimer</button>
          <button class="btn danger" id="btnReset" title="Effacer toutes les donn√©es locales">üóëÔ∏è Reset</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none">
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="side-head">
          <div class="search">
            <input class="input" id="searchAgent" placeholder="Rechercher un agent (nom, site, poste‚Ä¶)">
          </div>
          <div class="side-meta">
            <div id="metaCount">0 agent</div>
            <div id="metaSelected">Aucun s√©lectionn√©</div>
          </div>
        </div>
        <div class="list" id="agentList"></div>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="main-head">
          <div class="main-title">
            <h1 id="mainH1">S√©lectionne un agent</h1>
            <p id="mainP">
              Cette app enregistre les donn√©es <b>sur ton appareil</b> (localStorage). Pense √† faire des exports JSON.
              ‚ö†Ô∏è Si tu notes des √©l√©ments sensibles, fais-le de fa√ßon factuelle et conforme √† ton cadre (RGPD / interne).
            </p>
          </div>

          <div class="main-tools">
            <button class="btn small" id="btnDuplicate" title="Dupliquer l‚Äôagent s√©lectionn√©" disabled>üìÑ Dupliquer</button>
            <button class="btn small danger" id="btnDeleteAgent" title="Supprimer l‚Äôagent s√©lectionn√©" disabled>üóëÔ∏è Supprimer</button>
          </div>
        </div>

        <div class="scroll" id="mainScroll">
          <div class="empty" id="emptyState">
            <b>Astuce :</b> clique sur <b>Nouvel agent</b> pour cr√©er une fiche.<br>
            Ensuite tu pourras ajouter des <b>incidents</b>, des <b>actions</b>, des <b>suivis</b> et des <b>pi√®ces jointes</b>.
          </div>

          <div id="editor" style="display:none;">
            <div class="grid">
              <!-- Identity -->
              <details class="panel" open>
                <summary>
                  <span>Identit√©</span>
                  <span class="chev">‚åÑ</span>
                </summary>
                <div class="panel-body">
                  <div class="row">
                    <div class="field">
                      <label>Nom</label>
                      <input id="a_lastname" placeholder="Ex: DUPONT">
                    </div>
                    <div class="field">
                      <label>Pr√©nom</label>
                      <input id="a_firstname" placeholder="Ex: Sarah">
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>Date de naissance</label>
                      <input id="a_dob" type="date">
                    </div>
                    <div class="field">
                      <label>Matricule / R√©f√©rence interne</label>
                      <input id="a_ref" placeholder="Ex: AG-0123">
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>Nationalit√© (optionnel)</label>
                      <input id="a_nat" placeholder="Optionnel">
                    </div>
                    <div class="field">
                      <label>Pi√®ce / Autorisation (optionnel)</label>
                      <input id="a_auth" placeholder="Ex: badge, autorisation site‚Ä¶">
                    </div>
                  </div>
                </div>
              </details>

              <!-- Job -->
              <details class="panel" open>
                <summary>
                  <span>Poste & Affectation</span>
                  <span class="chev">‚åÑ</span>
                </summary>
                <div class="panel-body">
                  <div class="row">
                    <div class="field">
                      <label>Poste</label>
                      <input id="a_role" placeholder="Ex: Agent d‚Äôentretien / Chef d‚Äô√©quipe‚Ä¶">
                    </div>
                    <div class="field">
                      <label>Site / Chantier</label>
                      <input id="a_site" placeholder="Ex: R√©sidence X / Bureau Y">
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>Type de contrat</label>
                      <select id="a_contract">
                        <option value="">‚Äî</option>
                        <option>CDI</option>
                        <option>CDD</option>
                        <option>Int√©rim</option>
                        <option>Vacataire</option>
                        <option>Apprentissage</option>
                        <option>Autre</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Temps de travail</label>
                      <input id="a_hours" placeholder="Ex: 30h/semaine, 7h-12h‚Ä¶">
                    </div>
                  </div>
                  <div class="row">
                    <div class="field">
                      <label>R√©f√©rent / Manager</label>
                      <input id="a_manager" placeholder="Ex: Nom du chef d‚Äô√©quipe / responsable">
                    </div>
                    <div class="field">
                      <label>Date d‚Äôentr√©e (optionnel)</label>
                      <input id="a_start" type="date">
                    </div>
                  </div>
                </div>
              </details>

              <!-- Contact -->
              <details class="panel">
                <summary>
                  <span>Coordonn√©es</span>
                  <span class="chev">‚åÑ</span>
                </summary>
                <div class="panel-body">
                  <div class="row">
                    <div class="field">
                      <label>T√©l√©phone</label>
                      <input id="a_phone" inputmode="tel" placeholder="Ex: 06‚Ä¶">
                    </div>
                    <div class="field">
                      <label>Email</label>
                      <input id="a_email" inputmode="email" placeholder="Ex: nom@domaine.fr">
                    </div>
                  </div>
                  <div class="row one">
                    <div class="field">
                      <label>Adresse</label>
                      <input id="a_address" placeholder="Ex: 12 rue ‚Ä¶, 31000 Toulouse">
                    </div>
                  </div>

                  <div class="hr"></div>

                  <div class="row">
                    <div class="field">
                      <label>Contact d‚Äôurgence ‚Äì Nom</label>
                      <input id="a_em_name" placeholder="Ex: Parent / conjoint‚Ä¶">
                    </div>
                    <div class="field">
                      <label>Contact d‚Äôurgence ‚Äì T√©l√©phone</label>
                      <input id="a_em_phone" inputmode="tel" placeholder="Ex: 06‚Ä¶">
                    </div>
                  </div>
                  <div class="row one">
                    <div class="field">
                      <label>Contact d‚Äôurgence ‚Äì Lien</label>
                      <input id="a_em_link" placeholder="Ex: m√®re, fr√®re, conjoint‚Ä¶">
                    </div>
                  </div>
                </div>
              </details>

              <!-- Skills -->
              <details class="panel">
                <summary>
                  <span>Comp√©tences & Autorisations</span>
                  <span class="chev">‚åÑ</span>
                </summary>
                <div class="panel-body">
                  <div class="row">
                    <div class="field">
                      <label>Comp√©tences cl√©s</label>
                      <textarea id="a_skills" placeholder="Ex: vitrerie, autolaveuse, bio-nettoyage, remise en √©tat‚Ä¶"></textarea>
                      <div class="hint">Astuce : une comp√©tence par ligne.</div>
                    </div>
                    <div class="field">
                      <label>Mat√©riel / acc√®s / habilitations</label>
                      <textarea id="a_clearances" placeholder="Ex: clefs, badge, alarme, acc√®s local technique, EPI‚Ä¶"></textarea>
                    </div>
                  </div>
                </div>
              </details>

              <!-- General notes -->
              <details class="panel" open>
                <summary>
                  <span>Notes g√©n√©rales (suivi agent)</span>
                  <span class="chev">‚åÑ</span>
                </summary>
                <div class="panel-body">
                  <div class="row one">
                    <div class="field">
                      <label>Notes</label>
                      <textarea id="a_notes" placeholder="Tout ce qui peut √™tre utile : organisation, points forts, points de vigilance, remarques clients‚Ä¶"></textarea>
                      <div class="hint">Conseil : reste factuel (quoi, quand, o√π, avec preuves si besoin).</div>
                    </div>
                  </div>
                </div>
              </details>
            </div>

            <div class="hr"></div>

            <!-- Behavior / Incidents -->
            <details class="panel" open>
              <summary>
                <span>Suivi comportement / incidents</span>
                <span class="chev">‚åÑ</span>
              </summary>
              <div class="panel-body">
                <div class="incident-form">
                  <div class="row">
                    <div class="field">
                      <label>Date & heure</label>
                      <input id="i_datetime" type="datetime-local">
                    </div>
                    <div class="field">
                      <label>Type</label>
                      <select id="i_type">
                        <option value="">‚Äî</option>
                        <option>Retard / absence</option>
                        <option>Non-respect consignes</option>
                        <option>Qualit√© insuffisante</option>
                        <option>Attitude / comportement</option>
                        <option>Conflit / altercation</option>
                        <option>Manquement s√©curit√©</option>
                        <option>Mat√©riel / d√©gradation</option>
                        <option>Autre</option>
                      </select>
                    </div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label>Lieu / site concern√©</label>
                      <input id="i_place" placeholder="Ex: R√©sidence X, cage B, local poubelle‚Ä¶">
                    </div>
                    <div class="field">
                      <label>Gravit√©</label>
                      <select id="i_sev">
                        <option value="faible">Faible</option>
                        <option value="moyenne">Moyenne</option>
                        <option value="haute">Haute</option>
                      </select>
                    </div>
                  </div>

                  <div class="row one">
                    <div class="field">
                      <label>Faits (description pr√©cise)</label>
                      <textarea id="i_desc" placeholder="D√©crire les faits de fa√ßon objective : quoi, quand, o√π, √©l√©ments constat√©s‚Ä¶"></textarea>
                    </div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label>T√©moins (optionnel)</label>
                      <input id="i_wit" placeholder="Ex: Nom, fonction‚Ä¶">
                    </div>
                    <div class="field">
                      <label>Statut</label>
                      <select id="i_status">
                        <option value="ouvert">Ouvert</option>
                        <option value="clos">Clos</option>
                      </select>
                    </div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label>Actions imm√©diates (optionnel)</label>
                      <textarea id="i_actions" placeholder="Ex: rappel consignes, reprise, photo, message‚Ä¶"></textarea>
                    </div>
                    <div class="field">
                      <label>Suivi / d√©cision (optionnel)</label>
                      <textarea id="i_follow" placeholder="Ex: entretien pr√©vu, avertissement, formation, changement planning‚Ä¶"></textarea>
                    </div>
                  </div>

                  <div class="row one">
                    <div class="field">
                      <label>Pi√®ce jointe (photo/pdf) ‚Äì optionnel</label>
                      <input id="i_file" type="file" accept="image/*,application/pdf">
                      <div class="hint">
                        ‚ö†Ô∏è Stockage local : les pi√®ces jointes sont enregistr√©es en base64 (√ßa peut vite ‚Äúremplir‚Äù le navigateur).
                        Pour les gros PDF, pr√©f√®re les garder ailleurs et noter le nom/r√©f√©rence dans le texte.
                      </div>
                    </div>
                  </div>

                  <div class="split">
                    <div class="hint" id="editHint" style="margin:0;"></div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                      <button class="btn small" id="btnClearIncident" type="button">‚Ü∫ Effacer</button>
                      <button class="btn small primary" id="btnSaveIncident" type="button">‚úì Enregistrer l‚Äôincident</button>
                    </div>
                  </div>
                </div>

                <div class="incident-list" id="incidentList"></div>
                <div class="empty" id="incidentEmpty" style="display:none;">
                  Aucun incident enregistr√© pour cet agent.
                </div>
              </div>
            </details>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    /***************
     * KONTROL ‚Äì Dossier Agent & Suivi (localStorage)
     ***************/
    const STORAGE_KEY = "KONTROL_AGENT_DOSSIERS_V1";
    const $ = (id) => document.getElementById(id);

    const state = {
      data: { agents: [] },
      selectedId: null,
      incidentEditingId: null,
      filter: ""
    };

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function nowISO(){ return new Date().toISOString(); }

    function formatDT(isoOrLocal){
      if(!isoOrLocal) return "‚Äî";
      const d = new Date(isoOrLocal);
      if (isNaN(d.getTime())) return isoOrLocal;
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
      renderAll();
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && Array.isArray(parsed.agents)) state.data = parsed;
        }
      }catch(e){
        console.warn("Erreur chargement:", e);
      }
    }

    function getSelected(){
      return state.data.agents.find(a => a.id === state.selectedId) || null;
    }

    function escapeHTML(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function agentDisplayName(a){
      const ln = (a.identity?.lastname || "").trim();
      const fn = (a.identity?.firstname || "").trim();
      const full = `${ln} ${fn}`.trim();
      return full || "Agent sans nom";
    }

    function agentSubtitle(a){
      const role = (a.job?.role || "").trim();
      const site = (a.job?.site || "").trim();
      const parts = [];
      if(role) parts.push(role);
      if(site) parts.push(site);
      return parts.join(" ‚Ä¢ ") || "‚Äî";
    }

    function severityPill(sev){
      if(sev === "haute") return { cls:"danger", label:"Haute" };
      if(sev === "moyenne") return { cls:"warn", label:"Moyenne" };
      return { cls:"ok", label:"Faible" };
    }

    function agentOpenIncidentsCount(a){
      const incidents = a.behavior?.incidents || [];
      return incidents.filter(i => (i.status || "ouvert") === "ouvert").length;
    }
    function agentTotalIncidentsCount(a){
      return (a.behavior?.incidents || []).length;
    }

    function sortAgents(list){
      return [...list].sort((x,y)=>{
        const xl = (x.identity?.lastname || "").toLowerCase();
        const yl = (y.identity?.lastname || "").toLowerCase();
        if(xl < yl) return -1;
        if(xl > yl) return 1;
        const xf = (x.identity?.firstname || "").toLowerCase();
        const yf = (y.identity?.firstname || "").toLowerCase();
        if(xf < yf) return -1;
        if(xf > yf) return 1;
        const xu = x.updatedAt || "";
        const yu = y.updatedAt || "";
        return yu.localeCompare(xu);
      });
    }

    function filterAgents(list, q){
      const s = (q || "").trim().toLowerCase();
      if(!s) return list;
      return list.filter(a=>{
        const hay = [
          agentDisplayName(a),
          agentSubtitle(a),
          a.identity?.ref || "",
          a.contact?.phone || "",
          a.contact?.email || ""
        ].join(" ").toLowerCase();
        return hay.includes(s);
      });
    }

    function ensureAgentShape(a){
      a.identity ||= {};
      a.job ||= {};
      a.contact ||= {};
      a.emergency ||= {};
      a.skills ||= {};
      a.notes ||= {};
      a.behavior ||= {};
      a.behavior.incidents ||= [];
      return a;
    }

    function setVal(id, v){
      const el = $(id);
      if(!el) return;
      el.value = v ?? "";
    }
    function readVal(id){
      const el = $(id);
      return el ? el.value : "";
    }

    function renderSidebar(){
      const listEl = $("agentList");
      listEl.innerHTML = "";

      const filtered = filterAgents(state.data.agents, state.filter);
      const sorted = sortAgents(filtered);

      $("metaCount").textContent = `${sorted.length} agent${sorted.length>1?"s":""}`;
      $("metaSelected").textContent = state.selectedId ? "S√©lectionn√©" : "Aucun s√©lectionn√©";

      if(sorted.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.innerHTML = `<b>Aucun agent</b><br>Cr√©e une fiche avec <b>Nouvel agent</b> ou importe un JSON.`;
        listEl.appendChild(empty);
        return;
      }

      sorted.forEach(a=>{
        const card = document.createElement("div");
        card.className = "agent-card" + (a.id === state.selectedId ? " active" : "");
        card.addEventListener("click", ()=>{
          state.selectedId = a.id;
          state.incidentEditingId = null;
          renderAll();
        });

        const openCount = agentOpenIncidentsCount(a);
        const totalCount = agentTotalIncidentsCount(a);

        card.innerHTML = `
          <div class="agent-line1">
            <div class="agent-name">${escapeHTML(agentDisplayName(a))}</div>
            <div class="badges">
              ${openCount>0 ? `<span class="badge danger">‚ö†Ô∏è ${openCount} ouvert${openCount>1?"s":""}</span>` : `<span class="badge brand">‚úì OK</span>`}
              ${totalCount>0 ? `<span class="badge">${totalCount} total</span>` : ``}
            </div>
          </div>
          <div class="agent-sub">
            <span>${escapeHTML(agentSubtitle(a))}</span>
            <span class="dot">‚Ä¢</span>
            <span>Maj: ${escapeHTML(formatDT(a.updatedAt || a.createdAt || ""))}</span>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function renderMain(){
      const sel = getSelected();
      const editor = $("editor");
      const empty = $("emptyState");

      $("btnDeleteAgent").disabled = !sel;
      $("btnDuplicate").disabled = !sel;

      if(!sel){
        $("mainH1").textContent = "S√©lectionne un agent";
        $("mainP").innerHTML =
          `Cette app enregistre les donn√©es <b>sur ton appareil</b> (localStorage). Pense √† faire des exports JSON.
           ‚ö†Ô∏è Si tu notes des √©l√©ments sensibles, fais-le de fa√ßon factuelle et conforme √† ton cadre (RGPD / interne).`;
        empty.style.display = "block";
        editor.style.display = "none";
        return;
      }

      empty.style.display = "none";
      editor.style.display = "block";

      $("mainH1").textContent = agentDisplayName(sel);
      $("mainP").innerHTML = `
        <b>Poste :</b> ${escapeHTML(sel.job?.role || "‚Äî")} &nbsp;‚Ä¢&nbsp;
        <b>Site :</b> ${escapeHTML(sel.job?.site || "‚Äî")} &nbsp;‚Ä¢&nbsp;
        <b>Incidents :</b> ${agentTotalIncidentsCount(sel)} (dont ${agentOpenIncidentsCount(sel)} ouverts)
      `;

      setVal("a_lastname", sel.identity?.lastname);
      setVal("a_firstname", sel.identity?.firstname);
      setVal("a_dob", sel.identity?.dob);
      setVal("a_ref", sel.identity?.ref);
      setVal("a_nat", sel.identity?.nationality);
      setVal("a_auth", sel.identity?.authorization);

      setVal("a_role", sel.job?.role);
      setVal("a_site", sel.job?.site);
      setVal("a_contract", sel.job?.contract);
      setVal("a_hours", sel.job?.hours);
      setVal("a_manager", sel.job?.manager);
      setVal("a_start", sel.job?.startDate);

      setVal("a_phone", sel.contact?.phone);
      setVal("a_email", sel.contact?.email);
      setVal("a_address", sel.contact?.address);
      setVal("a_em_name", sel.emergency?.name);
      setVal("a_em_phone", sel.emergency?.phone);
      setVal("a_em_link", sel.emergency?.relation);

      setVal("a_skills", sel.skills?.skillsText);
      setVal("a_clearances", sel.skills?.clearancesText);
      setVal("a_notes", sel.notes?.general);

      renderIncidents(sel);
    }

    function renderIncidents(agent){
      const list = $("incidentList");
      const empty = $("incidentEmpty");
      list.innerHTML = "";

      const incidents = (agent.behavior?.incidents || []).slice().sort((a,b)=>{
        const da = new Date(a.datetime || a.createdAt || 0).getTime();
        const db = new Date(b.datetime || b.createdAt || 0).getTime();
        return db - da;
      });

      empty.style.display = incidents.length ? "none" : "block";

      incidents.forEach(i=>{
        const pill = severityPill(i.severity || "faible");
        const status = (i.status || "ouvert");
        const statusPill = status === "clos"
          ? `<span class="pill ok">‚úì Clos</span>`
          : `<span class="pill danger">‚ö†Ô∏è Ouvert</span>`;

        const attachLinks = (i.attachments || []).map((f, idx)=>{
          const safeName = escapeHTML(f.name || `fichier_${idx+1}`);
          if(f.dataUrl){
            return `<div>üìé <a href="${f.dataUrl}" download="${safeName}">${safeName}</a> <span style="opacity:.75;">(${escapeHTML(f.type||"")})</span></div>`;
          }
          return `<div>üìé ${safeName}</div>`;
        }).join("");

        const headType = i.type ? `${i.type}` : "Incident";
        const headPlace = i.place ? `‚Ä¢ ${i.place}` : "";
        const meta = `${formatDT(i.datetime)} ${headPlace}`.trim();

        const bodyParts = [];
        if(i.description) bodyParts.push("üßæ Faits :\n" + i.description);
        if(i.witnesses) bodyParts.push("üë• T√©moins : " + i.witnesses);
        if(i.actions) bodyParts.push("‚ö° Actions imm√©diates :\n" + i.actions);
        if(i.followUp) bodyParts.push("üìå Suivi / d√©cision :\n" + i.followUp);

        const bodyText = bodyParts.join("\n\n");

        const card = document.createElement("div");
        card.className = "incident";
        card.innerHTML = `
          <div class="incident-top">
            <div class="incident-title">
              <div class="line">${escapeHTML(headType)}</div>
              <div class="meta">${escapeHTML(meta || "‚Äî")}</div>
            </div>
            <div class="badges">
              ${statusPill}
              <span class="pill ${pill.cls}">‚öôÔ∏è Gravit√©: ${pill.label}</span>
            </div>
          </div>

          <div class="incident-body">${escapeHTML(bodyText || "‚Äî").replace(/\n/g, "<br>")}</div>

          ${attachLinks ? `<div class="attach">${attachLinks}</div>` : ""}

          <div class="incident-actions">
            <button class="btn small" type="button" data-action="edit" data-id="${i.id}">‚úèÔ∏è Modifier</button>
            ${status === "ouvert"
              ? `<button class="btn small" type="button" data-action="close" data-id="${i.id}">‚úì Cl√¥turer</button>`
              : `<button class="btn small warn" type="button" data-action="reopen" data-id="${i.id}">‚Ü©Ô∏è R√©ouvrir</button>`
            }
            <button class="btn small danger" type="button" data-action="delete" data-id="${i.id}">üóëÔ∏è Supprimer</button>
          </div>
        `;

        card.querySelectorAll("button[data-action]").forEach(btn=>{
          btn.addEventListener("click", ()=> handleIncidentAction(btn.dataset.action, btn.dataset.id));
        });

        list.appendChild(card);
      });
    }

    function toDatetimeLocal(val){
      if(!val) return "";
      if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(val)) return val;
      const d = new Date(val);
      if(isNaN(d.getTime())) return "";
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function handleIncidentAction(action, id){
      const agent = getSelected();
      if(!agent) return;
      const incidents = agent.behavior?.incidents || [];
      const idx = incidents.findIndex(x => x.id === id);
      if(idx < 0) return;

      if(action === "edit"){
        const i = incidents[idx];
        state.incidentEditingId = i.id;
        setVal("i_datetime", toDatetimeLocal(i.datetime));
        setVal("i_type", i.type);
        setVal("i_place", i.place);
        setVal("i_sev", i.severity || "faible");
        setVal("i_desc", i.description);
        setVal("i_wit", i.witnesses);
        setVal("i_status", i.status || "ouvert");
        setVal("i_actions", i.actions);
        setVal("i_follow", i.followUp);
        $("i_file").value = "";
        $("editHint").textContent = "Mode √©dition : tu modifies un incident existant.";
        return;
      }

      if(action === "close"){
        incidents[idx].status = "clos";
        incidents[idx].updatedAt = nowISO();
        agent.updatedAt = nowISO();
        save();
        return;
      }

      if(action === "reopen"){
        incidents[idx].status = "ouvert";
        incidents[idx].updatedAt = nowISO();
        agent.updatedAt = nowISO();
        save();
        return;
      }

      if(action === "delete"){
        if(!confirm("Supprimer cet incident ?")) return;
        incidents.splice(idx,1);
        agent.updatedAt = nowISO();
        save();
        return;
      }
    }

    function clearIncidentForm(){
      state.incidentEditingId = null;
      setVal("i_datetime", "");
      setVal("i_type", "");
      setVal("i_place", "");
      setVal("i_sev", "faible");
      setVal("i_desc", "");
      setVal("i_wit", "");
      setVal("i_status", "ouvert");
      setVal("i_actions", "");
      setVal("i_follow", "");
      $("i_file").value = "";
      $("editHint").textContent = "";
    }

    let saveTimer = null;
    function debounceSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
        renderSidebar();
        renderMain();
      }, 250);
    }

    function bindFieldAutoSave(){
      const ids = [
        "a_lastname","a_firstname","a_dob","a_ref","a_nat","a_auth",
        "a_role","a_site","a_contract","a_hours","a_manager","a_start",
        "a_phone","a_email","a_address","a_em_name","a_em_phone","a_em_link",
        "a_skills","a_clearances","a_notes"
      ];

      ids.forEach(id=>{
        const el = $(id);
        el.addEventListener("input", ()=>{
          const agent = getSelected();
          if(!agent) return;
          ensureAgentShape(agent);

          agent.identity.lastname = readVal("a_lastname").trim();
          agent.identity.firstname = readVal("a_firstname").trim();
          agent.identity.dob = readVal("a_dob");
          agent.identity.ref = readVal("a_ref").trim();
          agent.identity.nationality = readVal("a_nat").trim();
          agent.identity.authorization = readVal("a_auth").trim();

          agent.job.role = readVal("a_role").trim();
          agent.job.site = readVal("a_site").trim();
          agent.job.contract = readVal("a_contract");
          agent.job.hours = readVal("a_hours").trim();
          agent.job.manager = readVal("a_manager").trim();
          agent.job.startDate = readVal("a_start");

          agent.contact.phone = readVal("a_phone").trim();
          agent.contact.email = readVal("a_email").trim();
          agent.contact.address = readVal("a_address").trim();

          agent.emergency.name = readVal("a_em_name").trim();
          agent.emergency.phone = readVal("a_em_phone").trim();
          agent.emergency.relation = readVal("a_em_link").trim();

          agent.skills.skillsText = readVal("a_skills");
          agent.skills.clearancesText = readVal("a_clearances");

          agent.notes.general = readVal("a_notes");

          agent.updatedAt = nowISO();
          debounceSave();
        });
      });
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function onSaveIncident(){
      const agent = getSelected();
      if(!agent) return;
      ensureAgentShape(agent);

      const dt = readVal("i_datetime");
      const type = readVal("i_type").trim();
      const place = readVal("i_place").trim();
      const sev = readVal("i_sev");
      const desc = readVal("i_desc").trim();
      const wit = readVal("i_wit").trim();
      const status = readVal("i_status");
      const actions = readVal("i_actions").trim();
      const follow = readVal("i_follow").trim();

      if(!dt && !type && !desc){
        alert("Ajoute au minimum une date, un type ou une description.");
        return;
      }

      const fileInput = $("i_file");
      let attachment = null;

      if(fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        try{
          const dataUrl = await fileToDataUrl(f);
          attachment = { name: f.name, type: f.type, dataUrl };
        }catch(e){
          console.warn(e);
          alert("Impossible de lire la pi√®ce jointe.");
        }
      }

      const incidents = agent.behavior.incidents;

      if(state.incidentEditingId){
        const idx = incidents.findIndex(x => x.id === state.incidentEditingId);
        if(idx >= 0){
          const old = incidents[idx];
          old.datetime = dt;
          old.type = type;
          old.place = place;
          old.severity = sev;
          old.description = desc;
          old.witnesses = wit;
          old.status = status;
          old.actions = actions;
          old.followUp = follow;
          old.updatedAt = nowISO();
          if(attachment){
            old.attachments ||= [];
            old.attachments.push(attachment);
          }
        }
      }else{
        const item = {
          id: uid("inc"),
          createdAt: nowISO(),
          updatedAt: nowISO(),
          datetime: dt,
          type, place,
          severity: sev,
          description: desc,
          witnesses: wit,
          status,
          actions,
          followUp: follow,
          attachments: attachment ? [attachment] : []
        };
        incidents.push(item);
      }

      agent.updatedAt = nowISO();
      clearIncidentForm();
      save();
    }

    function newAgent(){
      const a = ensureAgentShape({
        id: uid("agent"),
        createdAt: nowISO(),
        updatedAt: nowISO(),
        identity: { lastname:"", firstname:"", dob:"", ref:"", nationality:"", authorization:"" },
        job: { role:"", site:"", contract:"", hours:"", manager:"", startDate:"" },
        contact: { phone:"", email:"", address:"" },
        emergency: { name:"", phone:"", relation:"" },
        skills: { skillsText:"", clearancesText:"" },
        notes: { general:"" },
        behavior: { incidents: [] }
      });
      state.data.agents.push(a);
      state.selectedId = a.id;
      state.incidentEditingId = null;
      save();
      setTimeout(()=> $("a_lastname").focus(), 50);
    }

    function deleteSelectedAgent(){
      const sel = getSelected();
      if(!sel) return;
      if(!confirm(`Supprimer l‚Äôagent "${agentDisplayName(sel)}" ? (irr√©versible)`)) return;
      state.data.agents = state.data.agents.filter(a => a.id !== sel.id);
      state.selectedId = null;
      state.incidentEditingId = null;
      save();
    }

    function duplicateSelectedAgent(){
      const sel = getSelected();
      if(!sel) return;
      const copy = JSON.parse(JSON.stringify(sel));
      copy.id = uid("agent");
      copy.createdAt = nowISO();
      copy.updatedAt = nowISO();
      copy.behavior ||= { incidents: [] };
      copy.behavior.incidents = (copy.behavior.incidents || []).map(i => ({
        ...i,
        id: uid("inc"),
        createdAt: i.createdAt || nowISO(),
        updatedAt: nowISO()
      }));
      state.data.agents.push(copy);
      state.selectedId = copy.id;
      state.incidentEditingId = null;
      save();
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state.data, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "kontrol_dossiers_agents.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(!parsed || !Array.isArray(parsed.agents)) throw new Error("Format invalide");
          parsed.agents.forEach(ensureAgentShape);
          state.data = parsed;
          state.selectedId = state.data.agents[0]?.id || null;
          state.incidentEditingId = null;
          save();
        }catch(e){
          alert("Fichier JSON invalide.");
        }
      };
      reader.readAsText(file);
    }

    function resetAll(){
      if(!confirm("Tout effacer (donn√©es locales) ?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state.data = { agents: [] };
      state.selectedId = null;
      state.incidentEditingId = null;
      state.filter = "";
      $("searchAgent").value = "";
      renderAll();
    }

    function renderAll(){
      renderSidebar();
      renderMain();
    }

    function bindEvents(){
      $("btnNewAgent").addEventListener("click", newAgent);
      $("btnDeleteAgent").addEventListener("click", deleteSelectedAgent);
      $("btnDuplicate").addEventListener("click", duplicateSelectedAgent);

      $("btnExport").addEventListener("click", exportJSON);
      $("btnImport").addEventListener("click", ()=> $("fileImport").click());
      $("fileImport").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(f) importJSONFile(f);
        e.target.value = "";
      });

      $("btnReset").addEventListener("click", resetAll);

      $("btnPrint").addEventListener("click", ()=> window.print());

      $("searchAgent").addEventListener("input", (e)=>{
        state.filter = e.target.value || "";
        renderSidebar();
      });

      $("btnClearIncident").addEventListener("click", clearIncidentForm);
      $("btnSaveIncident").addEventListener("click", onSaveIncident);

      $("i_datetime").addEventListener("focus", ()=>{
        if(!$("i_datetime").value){
          const d = new Date();
          const pad = n => String(n).padStart(2,"0");
          $("i_datetime").value =
            `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
      });
    }

    /* Init */
    load();
    bindEvents();
    bindFieldAutoSave();

    if(state.data.agents.length && !state.selectedId){
      state.selectedId = state.data.agents[0].id;
    }
    renderAll();
  </script>
</body>
</html>
