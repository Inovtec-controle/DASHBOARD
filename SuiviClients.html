<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>KONTROL - Suivi des retours</title>

  <!-- iPhone friendly -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#16a34a">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* TH√àME CLAIR STYLE KONTROL */
      --bg:#f1f5f9;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(148,163,184,.4);
      --brand:#16a34a;
      --brand-soft:rgba(22,163,74,.08);
      --danger:#ef4444;
      --danger-soft:rgba(239,68,68,.08);
      --warning:#f59e0b;
      --warning-soft:rgba(245,158,11,.08);
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 40px rgba(15,23,42,.12);
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      -webkit-tap-highlight-color:transparent;
    }

    body {
      min-height:100vh;
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:stretch;
      padding:12px;
      padding-top:calc(12px + env(safe-area-inset-top, 0px));
      padding-bottom:calc(12px + env(safe-area-inset-bottom, 0px));
    }

    .page{
      width:100%;
      max-width:1024px;
      margin:0 auto;
    }

    /* Bandeau titre pleine largeur */
    .page-header{
      width:100%;
      margin-bottom:14px;
    }

    .page-header-inner{
      border-radius:24px;
      padding:14px 16px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#ecfdf5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow:var(--shadow-soft);
    }

    .page-header-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
    }

    .page-logo-dot{
      width:42px;
      height:42px;
      border-radius:16px;
      background:rgba(15,23,42,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:22px;
    }

    .page-title-text{
      font-size:17px;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
    }

    .page-subtitle{
      font-size:11px;
      opacity:.9;
      margin-top:3px;
    }

    .page-header-right{
      text-align:right;
      font-size:11px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.25);
      font-size:11px;
    }

    .pill span{
      font-size:13px;
    }

    .app-shell{
      width:100%;
      max-width:960px;
      margin:0 auto;
      padding-bottom:32px;
    }

    main{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .panel{
      background:var(--panel);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      padding:12px;
    }

    .filters{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:4px;
    }

    .chip-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .chip{
      flex:1 1 0;
      text-align:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      background:rgba(248,250,252,.9);
    }

    .chip.small{
      flex:0 0 auto;
      padding:5px 9px;
      font-size:11px;
    }

    .chip.active{
      border-color:var(--brand);
      background:var(--brand-soft);
      color:var(--brand);
      font-weight:600;
    }

    .chip.secondary.active{
      border-color:#0ea5e9;
      background:rgba(56,189,248,.1);
      color:#0369a1;
    }

    .subtext{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .list-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      margin-top:4px;
      gap:8px;
    }

    .list-header h2{
      font-size:14px;
      font-weight:600;
    }

    .btn-primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:none;
      font-size:13px;
      font-weight:600;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#f9fafb;
      box-shadow:0 10px 26px rgba(22,163,74,.45);
      cursor:pointer;
    }

    .btn-primary span.icon{
      font-size:16px;
    }

    .retour-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }

    .retour-card{
      border-radius:var(--radius-md);
      border:1px solid rgba(148,163,184,.45);
      padding:10px;
      background:radial-gradient(circle at top,#f9fafb,#eef2ff);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .retour-main-row{
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:flex-start;
    }

    .retour-title{
      font-size:13px;
      font-weight:600;
    }

    .badge-row{
      display:flex;
      gap:5px;
      flex-wrap:wrap;
      margin-top:4px;
    }

    .badge{
      font-size:10px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(248,250,252,.9);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .badge.type-reclam{
      border-color:#f97316;
      background:var(--warning-soft);
      color:#9a3412;
    }

    .badge.type-oi{
      border-color:#0ea5e9;
      background:rgba(56,189,248,.12);
      color:#075985;
    }

    .badge.status-en-cours{
      border-color:var(--brand);
      background:var(--brand-soft);
      color:var(--brand);
    }

    .badge.status-clos{
      border-color:#22c55e;
      background:rgba(34,197,94,.12);
      color:#15803d;
    }

    .archive-tag{
      font-size:10px;
      padding:2px 7px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
      margin-left:4px;
    }

    .retour-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      gap:8px;
    }

    .retour-meta{
      font-size:10px;
      color:var(--muted);
    }

    .see-detail{
      font-size:11px;
      color:var(--brand);
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:3px;
      background:none;
      border:none;
      padding:4px 6px;
      border-radius:999px;
      cursor:pointer;
    }

    .see-detail.unarchive{
      color:#0f172a;
      border:1px solid rgba(148,163,184,.6);
      background:#f9fafb;
      margin-left:4px;
    }

    .no-data{
      font-size:12px;
      color:var(--muted);
      padding:10px 4px 4px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      backdrop-filter:blur(12px);
      display:none;
      z-index:20;
      align-items:flex-end;
      justify-content:center;
    }

    .modal-backdrop.active{
      display:flex;
    }

    .modal{
      width:100%;
      max-width:960px;
      background:var(--panel);
      border-radius:22px 22px 0 0;
      border:1px solid var(--border);
      box-shadow:0 -10px 26px rgba(15,23,42,.4);
      margin-top:16px;
      padding:calc(16px + env(safe-area-inset-top, 0px)) 14px 18px;
      max-height:92vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      gap:8px;
    }

    .modal-header h2{
      font-size:15px;
      font-weight:700;
    }

    .modal-close-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      background:var(--panel);
      flex-shrink:0;
      cursor:pointer;
    }

    .modal-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-top:6px;
      margin-bottom:4px;
    }

    .form-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }

    label{
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:2px;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:13px;
      background:#f8fafc;
      -webkit-appearance:none;
    }

    textarea{
      min-height:70px;
      resize:vertical;
    }

    .btn-row{
      display:flex;
      gap:8px;
      margin-top:10px;
    }

    .btn-secondary{
      flex:1;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:13px;
      background:#f8fafc;
      color:var(--text);
      font-weight:500;
      cursor:pointer;
    }

    .btn-primary.full{
      width:100%;
      justify-content:center;
      margin-top:4px;
    }

    .status-steps{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }

    .step-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 8px;
      border-radius:10px;
      border:1px dashed rgba(148,163,184,.7);
      background:#f8fafc;
      gap:6px;
    }

    .step-main{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
    }

    .step-main .icon{
      width:22px;
      height:22px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      background:#e5e7eb;
    }

    .step-main strong{
      font-size:12px;
    }

    .step-sub{
      font-size:10px;
      color:var(--muted);
    }

    .step-row.done{
      border-style:solid;
      border-color:var(--brand);
      background:var(--brand-soft);
    }

    .step-row.done .step-main .icon{
      background:#22c55e;
      color:white;
    }

    .step-row.done .step-sub{
      color:#166534;
    }

    .step-action-btn{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:none;
      background:#0f172a;
      color:#f9fafb;
      white-space:nowrap;
      cursor:pointer;
    }

    .step-row.done .step-action-btn{
      background:#111827;
      opacity:.85;
    }

    .timeline{
      margin-top:10px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid rgba(148,163,184,.45);
      padding:8px 9px;
      max-height:160px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    .timeline-item{
      position:relative;
      padding-left:14px;
      margin-bottom:4px;
    }

    .timeline-item::before{
      content:"";
      position:absolute;
      left:4px;
      top:4px;
      width:3px;
      height:3px;
      border-radius:999px;
      background:#16a34a;
    }

    .timeline-date{
      font-size:10px;
      color:var(--muted);
    }

    .timeline-text{
      font-size:11px;
    }

    .photos-grid{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .photo-thumb{
      width:64px;
      height:64px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.5);
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .photo-label{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .danger-zone{
      margin-top:10px;
      padding:7px 8px;
      border-radius:12px;
      background:var(--danger-soft);
      border:1px dashed var(--danger);
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }

    .danger-zone p{
      font-size:11px;
      color:#7f1d1d;
    }

    .btn-danger{
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--danger);
      background:#fee2e2;
      color:#b91c1c;
      white-space:nowrap;
      cursor:pointer;
    }

    /* Archive (pied de page) */
    .archive-shell{
      width:100%;
      margin-top:10px;
    }

    .archive-panel{
      max-width:960px;
      margin:0 auto;
      background:var(--panel);
      border-radius:var(--radius-lg);
      border:1px dashed rgba(148,163,184,.7);
      padding:10px 12px 12px;
      box-shadow:0 10px 26px rgba(15,23,42,.08);
    }

    .archive-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }

    .archive-header-row h2{
      font-size:13px;
      font-weight:600;
    }

    .archive-subtext{
      font-size:10px;
      color:var(--muted);
    }

    .archive-search-row{
      display:flex;
      gap:6px;
      margin-top:4px;
    }

    .archive-search-row input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      padding:7px 10px;
      font-size:12px;
      background:#f8fafc;
    }

    .archive-list .retour-card{
      background:#f9fafb;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Titre pleine largeur -->
    <header class="page-header">
      <div class="page-header-inner">
        <div class="page-header-left">
          <div class="page-logo-dot">K</div>
          <div>
            <div class="page-title-text">KONTROL ‚Äì Suivi des retours</div>
            <div class="page-subtitle">R√©clamations & Ordres d‚Äôintervention ‚Äì de la r√©ception √† la cl√¥ture</div>
          </div>
        </div>
        <div class="page-header-right">
          <div class="pill">
            <span>üì≤</span> iPhone ready
          </div>
          <div style="margin-top:3px;">GitHub Pages / Stockage local</div>
        </div>
      </div>
    </header>

    <!-- Application principale -->
    <div class="app-shell">
      <main>
        <section class="panel">
          <div class="filters">
            <div class="chip-row" id="filter-status-row">
              <button class="chip" data-status-filter="all">Tous</button>
              <button class="chip active" data-status-filter="open">En cours</button>
              <button class="chip" data-status-filter="closed">Cl√¥tur√©s</button>
            </div>
            <div class="chip-row" id="filter-type-row">
              <button class="chip small active secondary" data-type-filter="all">Tout type</button>
              <button class="chip small secondary" data-type-filter="reclamation">R√©clamations</button>
              <button class="chip small secondary" data-type-filter="oi">Ordres d‚Äôintervention</button>
            </div>
            <p class="subtext">
              Suis chaque retour de A √† Z : r√©ception, consigne agent, correction, photo, validation client.
            </p>
          </div>

          <div class="list-header">
            <h2>Retours en cours (non cl√¥tur√©s)</h2>
            <button class="btn-primary" id="open-create-modal">
              <span class="icon">‚ûï</span>
              Nouveau
            </button>
          </div>

          <div id="retourList" class="retour-list"></div>
          <p id="noRetours" class="no-data" style="display:none;">
            Aucun retour en cours pour l‚Äôinstant. Clique sur <strong>Nouveau</strong> pour en cr√©er un.
          </p>
        </section>
      </main>
    </div>

    <!-- Zone de stockage des actions cl√¥tur√©es -->
    <div class="archive-shell">
      <section class="archive-panel">
        <div class="archive-header-row">
          <div>
            <h2>Stockage ‚Äì actions cl√¥tur√©es</h2>
            <div class="archive-subtext">
              Historique des r√©clamations / interventions termin√©es, tri√©es de la plus r√©cente √† la plus ancienne.
            </div>
          </div>
        </div>
        <div class="archive-search-row">
          <input
            type="text"
            id="archive-search"
            placeholder="Rechercher par nom de r√©sidence / chantier / client‚Ä¶"
            autocomplete="off"
          >
        </div>

        <div id="archiveList" class="retour-list archive-list"></div>
        <p id="archiveEmpty" class="no-data">
          Aucune action cl√¥tur√©e pour le moment.
        </p>
      </section>
    </div>
  </div>

  <!-- MODAL CR√âATION -->
  <div class="modal-backdrop" id="create-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Nouvelle r√©clamation / ordre d‚Äôintervention</h2>
        <button class="modal-close-btn" data-close-create>‚úï</button>
      </div>

      <div>
        <p class="modal-section-title">Informations g√©n√©rales</p>
        <div class="form-grid">
          <div>
            <label for="create-type">Type de retour</label>
            <select id="create-type">
              <option value="reclamation">R√©clamation client</option>
              <option value="oi">Ordre d‚Äôintervention</option>
            </select>
          </div>

          <div>
            <label for="create-site-name">R√©sidence / Site</label>
            <input
              type="text"
              id="create-site-name"
              placeholder="Ex : R√©sidence Les Ch√™nes ‚Äì B√¢t. B"
              autocomplete="off"
            >
          </div>

          <div>
            <label for="create-title">Titre / R√©f√©rence</label>
            <input type="text" id="create-title" placeholder="Ex : R√©clamation cage B ‚Äì R√©sidence X">
          </div>

          <div>
            <label for="create-client">Client / Contact</label>
            <input type="text" id="create-client" placeholder="Nom du client, syndic, g√©rant...">
          </div>

          <div>
            <label for="create-channel">Canal de r√©ception</label>
            <select id="create-channel">
              <option value="Mail">Mail</option>
              <option value="T√©l√©phone">T√©l√©phone</option>
              <option value="SMS">SMS / WhatsApp</option>
              <option value="Visite">Visite sur site</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <div>
            <label for="create-date">Date de r√©ception</label>
            <input type="date" id="create-date">
          </div>

          <div>
            <label for="create-agent">Agent responsable</label>
            <input type="text" id="create-agent" placeholder="Agent en charge de la correction">
          </div>

          <div>
            <label for="create-description">D√©tail de la r√©clamation / OI</label>
            <textarea id="create-description" placeholder="D√©cris pr√©cis√©ment la demande du client ou la non-conformit√© constat√©e."></textarea>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn-secondary" data-close-create>Annuler</button>
          <button class="btn-primary" id="save-retour">
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL D√âTAIL -->
  <div class="modal-backdrop" id="detail-backdrop">
    <div class="modal" id="detail-modal-inner">
      <div class="modal-header">
        <h2 id="detail-title">D√©tail du retour</h2>
        <button class="modal-close-btn" data-close-detail>‚úï</button>
      </div>

      <div id="detail-content">
        <!-- Contenu inject√© en JS -->
      </div>
    </div>
  </div>

  <script>
    /* === DATA === */
    var STORAGE_KEY = "kontrol_retours_v1";
    var retours = [];
    var currentFilters = {
      status: "open",  // all / open / closed (par d√©faut : EN COURS)
      type: "all"      // all / reclamation / oi
    };
    var currentDetailId = null;

    function loadRetours(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          retours = JSON.parse(raw);
        }else{
          retours = [];
        }
      }catch(e){
        retours = [];
      }
    }

    function saveRetours(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(retours));
      }catch(e){
        // si localStorage bloqu√© (mode priv√©), on ignore
      }
    }

    function formatDate(d){
      if(!d) return "";
      var dt = new Date(d);
      if(isNaN(dt)) return d;
      return dt.toLocaleDateString("fr-FR", {day:"2-digit",month:"2-digit",year:"numeric"});
    }

    function formatDateTime(d){
      if(!d) return "";
      var dt = new Date(d);
      if(isNaN(dt)) return d;
      return dt.toLocaleString("fr-FR", {
        day:"2-digit", month:"2-digit", year:"numeric",
        hour:"2-digit", minute:"2-digit"
      });
    }

    function computeStatus(retour){
      var s = retour.steps || {};
      if(s.retourClientOK){
        return "clos";
      }
      if(s.photoOK || s.correctionFaite || s.transmisAgent || s.messageRecu){
        return "en_cours";
      }
      return "en_cours";
    }

    /* === LISTE PRINCIPALE (EN COURS) === */
    function renderRetours(){
      var container = document.getElementById("retourList");
      var emptyLabel = document.getElementById("noRetours");
      container.innerHTML = "";

      var filtered = retours.slice().sort(function(a,b){
        return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0);
      });

      filtered = filtered.filter(function(r){
        var st = computeStatus(r);
        if(currentFilters.status === "open" && st === "clos") return false;   // ne pas afficher les clos dans "en cours"
        if(currentFilters.status === "closed" && st !== "clos") return false;
        if(currentFilters.type !== "all" && r.type !== currentFilters.type) return false;
        return true;
      });

      if(filtered.length === 0){
        emptyLabel.style.display = "block";
      }else{
        emptyLabel.style.display = "none";
      }

      filtered.forEach(function(retour){
        var card = document.createElement("article");
        card.className = "retour-card";

        var typeLabel = retour.type === "reclamation" ? "R√©clamation client" : "Ordre d‚Äôintervention";

        var siteLabel = retour.siteName ||
          (retour.siteType === "copro" ? "Contr√¥le copropri√©t√©" :
           retour.siteType === "bureaux" ? "Bureaux / Locaux tertiaires" :
           retour.siteType ? "Autre site" : "Site non d√©fini");

        var status = computeStatus(retour);
        var statusLabel = status === "clos" ? "Cl√¥tur√©" : "En cours";
        var statusClass = status === "clos" ? "badge status-clos" : "badge status-en-cours";

        var lastUpdate = formatDate(retour.updatedAt || retour.createdAt);
        var client = retour.client || "Client non renseign√©";

        card.innerHTML = `
          <div class="retour-main-row">
            <div>
              <div class="retour-title">${retour.title || "(Sans titre)"}</div>
              <div class="badge-row">
                <span class="badge ${retour.type === "reclamation" ? "type-reclam" : "type-oi"}">
                  <span>${retour.type === "reclamation" ? "üì£" : "üõ†Ô∏è"}</span>
                  ${typeLabel}
                </span>
                <span class="badge">
                  <span>üìç</span>${siteLabel}
                </span>
                <span class="${statusClass}">
                  <span>${status === "clos" ? "‚úÖ" : "‚è≥"}</span>${statusLabel}
                </span>
              </div>
            </div>
          </div>
          <div class="retour-footer">
            <div class="retour-meta">
              <div>Client : <strong>${client}</strong></div>
              <div>Derni√®re mise √† jour : ${lastUpdate || "‚Äî"}</div>
            </div>
            <button class="see-detail" data-open-detail="${retour.id}">
              D√©tail <span>‚Ä∫</span>
            </button>
          </div>
        `;
        container.appendChild(card);

        var detailBtn = card.querySelector("[data-open-detail]");
        if(detailBtn){
          detailBtn.addEventListener("click", function(){
            var id = detailBtn.getAttribute("data-open-detail");
            openDetailModal(id);
          });
        }
      });

      renderArchive(); // mettre √† jour la zone de stockage aussi
    }

    /* === ARCHIVE (ACTIONS CL√îTUR√âES) === */
    function renderArchive(){
      var list = document.getElementById("archiveList");
      var empty = document.getElementById("archiveEmpty");
      if(!list || !empty) return;

      list.innerHTML = "";
      var searchInput = document.getElementById("archive-search");
      var q = (searchInput && searchInput.value ? searchInput.value : "").toLowerCase().trim();

      var closed = retours.filter(function(r){
        return computeStatus(r) === "clos";
      });

      closed.sort(function(a,b){
        return (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0);
      });

      if(q){
        closed = closed.filter(function(r){
          var hay = ((r.title || "") + " " + (r.siteName || "") + " " + (r.client || "")).toLowerCase();
          return hay.indexOf(q) !== -1;
        });
      }

      if(closed.length === 0){
        empty.style.display = "block";
      }else{
        empty.style.display = "none";
      }

      closed.forEach(function(retour){
        var card = document.createElement("article");
        card.className = "retour-card";

        var typeLabel = retour.type === "reclamation" ? "R√©clamation client" : "Ordre d‚Äôintervention";
        var siteLabel = retour.siteName || "Site non d√©fini";
        var client = retour.client || "Client non renseign√©";
        var statusDate = formatDate(retour.updatedAt || retour.createdAt);

        card.innerHTML = `
          <div class="retour-main-row">
            <div>
              <div class="retour-title">
                ${retour.title || "(Sans titre)"}
                <span class="archive-tag">Cl√¥tur√©</span>
              </div>
              <div class="badge-row">
                <span class="badge ${retour.type === "reclamation" ? "type-reclam" : "type-oi"}">
                  <span>${retour.type === "reclamation" ? "üì£" : "üõ†Ô∏è"}</span>
                  ${typeLabel}
                </span>
                <span class="badge">
                  <span>üìç</span>${siteLabel}
                </span>
                <span class="badge">
                  <span>üë§</span>${client}
                </span>
              </div>
            </div>
          </div>
          <div class="retour-footer">
            <div class="retour-meta">
              <div>Derni√®re mise √† jour : ${statusDate || "‚Äî"}</div>
            </div>
            <div>
              <button class="see-detail" data-open-detail="${retour.id}">
                Ouvrir <span>‚Ä∫</span>
              </button>
              <button class="see-detail unarchive" data-unarchive="${retour.id}">
                D√©sarchiver
              </button>
            </div>
          </div>
        `;

        list.appendChild(card);

        var detailBtn = card.querySelector("[data-open-detail]");
        if(detailBtn){
          detailBtn.addEventListener("click", function(){
            var id = detailBtn.getAttribute("data-open-detail");
            openDetailModal(id);
          });
        }

        var unarchiveBtn = card.querySelector("[data-unarchive]");
        if(unarchiveBtn){
          unarchiveBtn.addEventListener("click", function(){
            var id = unarchiveBtn.getAttribute("data-unarchive");
            unarchiveRetour(id);
          });
        }
      });
    }

    function unarchiveRetour(id){
      var r = null;
      for(var i=0;i<retours.length;i++){
        if(retours[i].id === id){
          r = retours[i];
          break;
        }
      }
      if(!r) return;
      r.steps = r.steps || {};
      if(!r.steps.retourClientOK){
        return; // d√©j√† non clos
      }
      r.steps.retourClientOK = false; // r√©ouverture
      addTimelineEntry(r,"Dossier r√©-ouvert depuis la zone archivage.");
      r.updatedAt = Date.now();
      saveRetours();
      renderRetours();
    }

    /* === MODAL CR√âATION === */
    var createBackdrop = document.getElementById("create-backdrop");
    var openCreateBtn = document.getElementById("open-create-modal");
    var saveRetourBtn = document.getElementById("save-retour");

    function openCreateModal(){
      var dateInput = document.getElementById("create-date");
      if(dateInput && !dateInput.value){
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth()+1).padStart(2,"0");
        var dd = String(today.getDate()).padStart(2,"0");
        dateInput.value = yyyy + "-" + mm + "-" + dd;
      }
      createBackdrop.classList.add("active");
    }

    function closeCreateModal(){
      createBackdrop.classList.remove("active");
    }

    openCreateBtn.addEventListener("click", openCreateModal);

    (function(){
      var closeBtns = document.querySelectorAll("[data-close-create]");
      for(var i=0;i<closeBtns.length;i++){
        closeBtns[i].addEventListener("click", closeCreateModal);
      }
    })();

    // fermer cr√©ation en tapant sur le fond
    createBackdrop.addEventListener("click", function(e){
      if(e.target === createBackdrop){
        closeCreateModal();
      }
    });

    saveRetourBtn.addEventListener("click", function(){
      var type = document.getElementById("create-type").value;
      var siteName = document.getElementById("create-site-name").value.trim();
      var title = document.getElementById("create-title").value.trim();
      var client = document.getElementById("create-client").value.trim();
      var channel = document.getElementById("create-channel").value;
      var date = document.getElementById("create-date").value;
      var agent = document.getElementById("create-agent").value.trim();
      var description = document.getElementById("create-description").value.trim();

      var now = Date.now();
      var id = "R" + now.toString(36);

      var retour = {
        id: id,
        type: type,
        siteName: siteName,
        title: title,
        client: client,
        channel: channel,
        dateReception: date || null,
        agent: agent,
        description: description,
        createdAt: now,
        updatedAt: now,
        steps:{
          messageRecu:true,
          transmisAgent:false,
          correctionFaite:false,
          photoOK:false,
          retourClientOK:false
        },
        timeline:[
          {
            date:now,
            text:"Retour enregistr√© (" + (type === "reclamation" ? "R√©clamation client" : "Ordre d‚Äôintervention") + ") via " + channel + "."
          }
        ],
        photos:[]
      };

      retours.push(retour);
      saveRetours();
      closeCreateModal();
      renderRetours();
      openDetailModal(id);
    });

    /* === MODAL D√âTAIL === */
    var detailBackdrop = document.getElementById("detail-backdrop");
    var detailContent = document.getElementById("detail-content");
    var detailTitle = document.getElementById("detail-title");

    function closeDetailModal(){
      detailBackdrop.classList.remove("active");
      currentDetailId = null;
    }

    (function(){
      var closeBtns = document.querySelectorAll("[data-close-detail]");
      for(var i=0;i<closeBtns.length;i++){
        closeBtns[i].addEventListener("click", closeDetailModal);
      }
    })();

    // fermer d√©tail en tapant sur le fond
    detailBackdrop.addEventListener("click", function(e){
      if(e.target === detailBackdrop){
        closeDetailModal();
      }
    });

    function addTimelineEntry(retour, text){
      retour.timeline = retour.timeline || [];
      retour.timeline.unshift({
        date:Date.now(),
        text:text
      });
    }

    function openDetailModal(id){
      var retour = null;
      for(var i=0;i<retours.length;i++){
        if(retours[i].id === id){
          retour = retours[i];
          break;
        }
      }
      if(!retour) return;
      currentDetailId = id;
      renderDetail(retour);
      detailBackdrop.classList.add("active");
    }

    function renderDetail(retour){
      detailTitle.textContent = retour.title || "D√©tail du retour";
      var typeLabel = retour.type === "reclamation" ? "R√©clamation client" : "Ordre d‚Äôintervention";
      var siteLabel = retour.siteName ||
        (retour.siteType === "copro" ? "Contr√¥le copropri√©t√©" :
         retour.siteType === "bureaux" ? "Bureaux / Locaux tertiaires" :
         retour.siteType ? "Autre site" : "Site non d√©fini");
      var status = computeStatus(retour);
      var statusLabel = status === "clos" ? "Cl√¥tur√©" : "En cours";

      var steps = retour.steps || {};
      var photos = retour.photos || [];
      var timeline = retour.timeline || [];

      var timelineHtml;
      if(timeline.length === 0){
        timelineHtml = '<div class="timeline-item"><div class="timeline-text">Aucun historique pour l‚Äôinstant.</div></div>';
      }else{
        timelineHtml = timeline.map(function(item){
          return `
            <div class="timeline-item">
              <div class="timeline-date">${formatDateTime(item.date)}</div>
              <div class="timeline-text">${item.text}</div>
            </div>
          `;
        }).join("");
      }

      var photosHtml;
      if(photos.length === 0){
        photosHtml = '<span style="font-size:11px;color:var(--muted);">Aucune photo ajout√©e pour l‚Äôinstant.</span>';
      }else{
        photosHtml = photos.map(function(p){
          return `
            <div class="photo-thumb"><img src="${p.dataUrl}" alt="${p.name || "photo"}"></div>
          `;
        }).join("");
      }

      detailContent.innerHTML = `
        <div>
          <div class="badge-row" style="margin-bottom:8px;">
            <span class="badge ${retour.type === "reclamation" ? "type-reclam" : "type-oi"}">
              <span>${retour.type === "reclamation" ? "üì£" : "üõ†Ô∏è"}</span>${typeLabel}
            </span>
            <span class="badge">
              <span>üìç</span>${siteLabel}
            </span>
            <span class="badge ${status === "clos" ? "status-clos" : "status-en-cours"}">
              <span>${status === "clos" ? "‚úÖ" : "‚è≥"}</span>${statusLabel}
            </span>
          </div>

          <p class="modal-section-title">Donn√©es client</p>
          <div class="form-grid">
            <div>
              <label>Client / Contact</label>
              <div style="font-size:12px;"><strong>${retour.client || "Non renseign√©"}</strong></div>
            </div>
            <div>
              <label>Canal de r√©ception</label>
              <div style="font-size:12px;">${retour.channel || "Non renseign√©"}</div>
            </div>
            <div>
              <label>Date de r√©ception</label>
              <div style="font-size:12px;">${formatDate(retour.dateReception)}</div>
            </div>
            <div>
              <label>Agent responsable</label>
              <div style="font-size:12px;">${retour.agent || "Non d√©fini"}</div>
            </div>
            <div>
              <label>Description initiale</label>
              <div style="font-size:12px;">${retour.description || "‚Äî"}</div>
            </div>
          </div>

          <p class="modal-section-title">√âtapes du suivi</p>
          <div class="status-steps">
            <div class="step-row ${steps.messageRecu ? "done" : ""}" data-step="messageRecu">
              <div class="step-main">
                <div class="icon">üì©</div>
                <div>
                  <strong>Message re√ßu</strong>
                  <div class="step-sub">R√©clamation / OI enregistr√©e dans KONTROL.</div>
                </div>
              </div>
              ${steps.messageRecu ? '<button class="step-action-btn" data-toggle-step="messageRecu">Annuler</button>' :
                '<button class="step-action-btn" data-toggle-step="messageRecu">Valider</button>'}
            </div>

            <div class="step-row ${steps.transmisAgent ? "done" : ""}" data-step="transmisAgent">
              <div class="step-main">
                <div class="icon">üì§</div>
                <div>
                  <strong>Consigne envoy√©e √† l‚Äôagent</strong>
                  <div class="step-sub">Instruction transmise (message, appel, etc.).</div>
                </div>
              </div>
              ${steps.transmisAgent ? '<button class="step-action-btn" data-toggle-step="transmisAgent">Annuler</button>' :
                '<button class="step-action-btn" data-toggle-step="transmisAgent">Valider</button>'}
            </div>

            <div class="step-row ${steps.correctionFaite ? "done" : ""}" data-step="correctionFaite">
              <div class="step-main">
                <div class="icon">‚úÖ</div>
                <div>
                  <strong>Correction r√©alis√©e</strong>
                  <div class="step-sub">T√¢che effectu√©e sur site par l‚Äôagent.</div>
                </div>
              </div>
              ${steps.correctionFaite ? '<button class="step-action-btn" data-toggle-step="correctionFaite">Annuler</button>' :
                '<button class="step-action-btn" data-toggle-step="correctionFaite">Valider</button>'}
            </div>

            <div class="step-row ${steps.photoOK ? "done" : ""}" data-step="photoOK">
              <div class="step-main">
                <div class="icon">üì∑</div>
                <div>
                  <strong>Photo de la correction</strong>
                  <div class="step-sub">Preuve visuelle envoy√©e / stock√©e.</div>
                </div>
              </div>
              ${steps.photoOK ? '<button class="step-action-btn" data-toggle-step="photoOK">Annuler</button>' :
                '<button class="step-action-btn" data-toggle-step="photoOK">Valider</button>'}
            </div>

            <div class="step-row ${steps.retourClientOK ? "done" : ""}" data-step="retourClientOK">
              <div class="step-main">
                <div class="icon">üòä</div>
                <div>
                  <strong>Retour client OK</strong>
                  <div class="step-sub">Client satisfait, dossier cl√¥tur√©.</div>
                </div>
              </div>
              ${steps.retourClientOK ? '<button class="step-action-btn" data-toggle-step="retourClientOK">Annuler</button>' :
                '<button class="step-action-btn" data-toggle-step="retourClientOK">Valider</button>'}
            </div>
          </div>

          <p class="modal-section-title">Notes / suivi</p>
          <div class="form-grid">
            <div>
              <label for="detail-new-note">Ajouter une note interne</label>
              <textarea id="detail-new-note" placeholder="Ex : Agent inform√© par SMS √† 10h15, retour pr√©vu demain matin."></textarea>
            </div>
            <button class="btn-primary full" id="detail-add-note">Ajouter la note au suivi</button>
          </div>

          <div class="timeline" id="detail-timeline">
            ${timelineHtml}
          </div>

          <p class="modal-section-title">Photos de la correction</p>
          <div class="form-grid">
            <div>
              <label for="detail-photo-input">Ajouter une photo (prise avec l‚ÄôiPhone)</label>
              <input type="file" id="detail-photo-input" accept="image/*">
              <div class="photo-label">Les photos sont stock√©es localement dans ton navigateur (pas d‚Äôenvoi sur un serveur).</div>
            </div>
            <div class="photos-grid" id="detail-photos">
              ${photosHtml}
            </div>
          </div>

          <div class="danger-zone">
            <p>Supprimer d√©finitivement ce retour si la r√©clamation / OI a √©t√© archiv√©e ailleurs.</p>
            <button class="btn-danger" id="detail-delete">Supprimer</button>
          </div>
        </div>
      `;

      // toggle √©tapes
      var stepBtns = detailContent.querySelectorAll("[data-toggle-step]");
      for(var i=0;i<stepBtns.length;i++){
        (function(btn){
          btn.addEventListener("click", function(){
            var stepKey = btn.getAttribute("data-toggle-step");
            toggleStep(retour.id, stepKey);
          });
        })(stepBtns[i]);
      }

      // ajout de note
      var addNoteBtn = document.getElementById("detail-add-note");
      addNoteBtn.addEventListener("click", function(){
        var textarea = document.getElementById("detail-new-note");
        var value = textarea.value.trim();
        if(!value) return;
        var r = null;
        for(var j=0;j<retours.length;j++){
          if(retours[j].id === retour.id){
            r = retours[j];
            break;
          }
        }
        if(!r) return;
        addTimelineEntry(r, value);
        r.updatedAt = Date.now();
        saveRetours();
        renderRetours();
        openDetailModal(r.id);
      });

      // ajout photo
      var photoInput = document.getElementById("detail-photo-input");
      photoInput.addEventListener("change", function(e){
        var file = e.target.files && e.target.files[0];
        if(!file) return;
        var reader = new FileReader();
        reader.onload = function(ev){
          var dataUrl = ev.target.result;
          var r = null;
          for(var k=0;k<retours.length;k++){
            if(retours[k].id === retour.id){
              r = retours[k];
              break;
            }
          }
          if(!r) return;
          r.photos = r.photos || [];
          r.photos.push({name:file.name, dataUrl:dataUrl});
          r.steps = r.steps || {};
          r.steps.photoOK = true;
          addTimelineEntry(r,"Photo de la correction ajout√©e.");
          r.updatedAt = Date.now();
          saveRetours();
          renderRetours();
          openDetailModal(r.id);
        };
        reader.readAsDataURL(file);
      });

      // suppression
      var deleteBtn = document.getElementById("detail-delete");
      deleteBtn.addEventListener("click", function(){
        if(!confirm("Supprimer d√©finitivement ce retour ?")){
          return;
        }
        retours = retours.filter(function(x){ return x.id !== retour.id; });
        saveRetours();
        closeDetailModal();
        renderRetours();
      });
    }

    function toggleStep(id, stepKey){
      var r = null;
      for(var i=0;i<retours.length;i++){
        if(retours[i].id === id){
          r = retours[i];
          break;
        }
      }
      if(!r) return;
      r.steps = r.steps || {};
      var newValue = !r.steps[stepKey];
      r.steps[stepKey] = newValue;

      var labelMap = {
        messageRecu:"√âtape ¬´ Message re√ßu ¬ª mise √† jour.",
        transmisAgent:"Consigne agent mise √† jour.",
        correctionFaite:"Correction r√©alis√©e mise √† jour.",
        photoOK:"√âtat de la photo de correction mis √† jour.",
        retourClientOK: newValue ? "Retour client OK, dossier cl√¥tur√©." : "Retour client OK annul√©."
      };
      addTimelineEntry(r, labelMap[stepKey] || "√âtape mise √† jour.");
      r.updatedAt = Date.now();
      saveRetours();
      renderRetours();
      openDetailModal(r.id);
    }

    /* === FILTRES === */
    document.getElementById("filter-status-row").addEventListener("click", function(e){
      var btn = e.target.closest(".chip");
      if(!btn) return;
      var value = btn.getAttribute("data-status-filter");
      if(!value) return;
      currentFilters.status = value;
      var all = document.querySelectorAll("[data-status-filter]");
      for(var i=0;i<all.length;i++){
        all[i].classList.remove("active");
      }
      btn.classList.add("active");
      renderRetours();
    });

    document.getElementById("filter-type-row").addEventListener("click", function(e){
      var btn = e.target.closest(".chip");
      if(!btn) return;
      var value = btn.getAttribute("data-type-filter");
      if(!value) return;
      currentFilters.type = value;
      var all = document.querySelectorAll("[data-type-filter]");
      for(var i=0;i<all.length;i++){
        all[i].classList.remove("active");
      }
      btn.classList.add("active");
      renderRetours();
    });

    // Recherche archive
    var archiveSearchInput = document.getElementById("archive-search");
    if(archiveSearchInput){
      archiveSearchInput.addEventListener("input", renderArchive);
    }

    /* === INIT === */
    loadRetours();
    // forcer l'√©tat visuel du filtre "En cours" (au cas o√π HTML serait modifi√©)
    (function syncStatusChips(){
      var chips = document.querySelectorAll("[data-status-filter]");
      for(var i=0;i<chips.length;i++){
        var v = chips[i].getAttribute("data-status-filter");
        chips[i].classList.toggle("active", v === currentFilters.status);
      }
    })();
    renderRetours();
  </script>
</body>
</html>
